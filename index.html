<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢èªèªè­‰è€ƒé¡Œå°å°ç¢° - ç²¾ç·»ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* å…¨å±€å­—é«”è¨­å®šï¼Œç¢ºä¿æ‰€æœ‰æ–‡å­—ä½¿ç”¨ Noto Sans TC */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #a8dadc, #457b9d); /* æ¸…æ–°è—ç¶ æ¼¸è®ŠèƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            overflow: hidden; /* é˜²æ­¢æ»¾å‹•æ¢å‡ºç¾ */
            position: relative;
            animation: backgroundFadeIn 1.5s ease-out forwards; /* èƒŒæ™¯è¼‰å…¥å‹•ç•« */
            /* æ¸¸æ¨™è¨­å®šï¼Œå‡è¨­æ‚¨æœ‰ images/cursor_normal.png æª”æ¡ˆ */
            /* cursor: url('images/cursor_normal.png'), auto; */
        }

        @keyframes backgroundFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* èƒŒæ™¯è£é£¾å…ƒç´ ï¼Œå¢åŠ ç•«é¢å±¤æ¬¡æ„Ÿï¼Œç‡Ÿé€ æ´»æ½‘æ°›åœ */
        body::before, body::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25); /* æ›´æ˜é¡¯çš„åŠé€æ˜ç™½è‰² */
            filter: blur(80px); /* æ›´æŸ”å’Œçš„æ¨¡ç³Š */
            z-index: 0;
            animation: floatBubble 12s infinite ease-in-out alternate; /* æ¼‚æµ®å‹•ç•« */
        }

        body::before {
            width: 300px;
            height: 300px;
            top: -100px;
            left: -100px;
            animation-delay: 0s;
        }

        body::after {
            width: 400px;
            height: 400px;
            bottom: -150px;
            right: -150px;
            animation-delay: 2s;
        }

        @keyframes floatBubble {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, -30px) scale(1.08); }
            100% { transform: translate(0, 0) scale(1); }
        }

        .main-card {
            background-color: rgba(255, 255, 255, 0.98); /* è¿‘ä¹ç™½è‰²ï¼Œæå‡è³ªæ„Ÿ */
            border-radius: 35px; /* æ›´åœ“æ½¤çš„åœ“è§’ */
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4); /* æ›´æ·±é‚ƒçš„é™°å½± */
            padding: 50px; /* å¢åŠ å…§é‚Šè· */
            width: 95%;
            max-width: 900px; /* å¢åŠ æœ€å¤§å¯¬åº¦ */
            text-align: center;
            border: 5px solid #80c7f2; /* æ›´å…·æ´»åŠ›çš„æ·ºè—è‰²é‚Šæ¡† */
            position: relative;
            z-index: 1;
            transform: scale(0.95); /* ç¨å¾®ç¸®å°ï¼Œçœ‹èµ·ä¾†æ›´ç²¾ç·» */
            animation: fadeInScale 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; /* è¼‰å…¥å‹•ç•« */
            box-sizing: border-box;
            opacity: 0; /* é è¨­éš±è—ï¼Œç”±å‹•ç•«é¡¯ç¤º */
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.7);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        h1 {
            font-family: 'Noto Sans TC', sans-serif;
            color: #0056b3;
            margin-bottom: 40px;
            font-size: 4.5em; /* å¢å¤§æ¨™é¡Œå­—é«” */
            text-shadow: 4px 4px 8px rgba(0,0,0,0.3);
            letter-spacing: 3px;
            background: linear-gradient(to right, #007bff, #00c6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900; /* åŠ ç²— */
            animation: pulseText 2s infinite alternate; /* æ¨™é¡Œè„ˆè¡å‹•ç•« */
        }

        @keyframes pulseText {
            0% { transform: scale(1); text-shadow: 4px 4px 8px rgba(0,0,0,0.3); }
            100% { transform: scale(1.02); text-shadow: 6px 6px 12px rgba(0,0,0,0.4); }
        }

        h2 {
            font-family: 'Noto Sans TC', sans-serif;
            color: #007bff;
            font-size: 3em; /* å¢å¤§å­—é«” */
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.15);
            font-weight: 700;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding: 15px 0;
            border-bottom: 2px dashed #e0e0e0; /* è™›ç·šåˆ†éš”ç·š */
        }

        .score-area, .timer-area {
            font-size: 2em; /* å¢å¤§å­—é«” */
            font-weight: bold;
            color: #28a745; /* ç¶ è‰² */
            background-color: #e6ffe6; /* æ·ºç¶ èƒŒæ™¯ */
            padding: 12px 25px;
            border-radius: 15px; /* æ›´åœ“æ½¤ */
            border: 3px solid #5cb85c; /* æ·±ä¸€é»çš„ç¶ è‰²é‚Šæ¡† */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* æ›´æ˜é¡¯é™°å½± */
            min-width: 180px; /* ç¢ºä¿å¯¬åº¦ */
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounceIn 0.8s ease-out; /* è¼‰å…¥å‹•ç•« */
        }

        .timer-area {
            color: #dc3545; /* ç´…è‰² */
            background-color: #ffe6e6; /* æ·ºç´…èƒŒæ™¯ */
            border: 3px solid #dc3545;
        }

        .timer-area.time-low {
            color: #ff0000;
            animation: pulseRed 0.8s infinite alternate;
        }

        @keyframes pulseRed {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.08); opacity: 0.8; }
        }

        .question-area {
            background-color: #f0f8ff; /* æ·ºè—è‰²èƒŒæ™¯ï¼Œæ›´æŸ”å’Œ */
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 40px;
            border: 3px solid #b3e5fc; /* æ·ºè—è‰²é‚Šæ¡† */
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1); /* æ›´æ·±é‚ƒçš„å…§é™°å½± */
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center; /* è®“å…§å®¹å‚ç›´å±…ä¸­ */
            align-items: center;
        }

        #question-text {
            font-size: 2.8em; /* å¢å¤§é¡Œç›®å­—é«” */
            margin-bottom: 30px;
            color: #1a4266; /* æ·±è—è‰² */
            line-height: 1.6;
            font-weight: bold;
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        /* åœ–ç‰‡é¡Œç›®æ¨£å¼ */
        #question-image {
            max-width: 90%;
            max-height: 250px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            margin-bottom: 25px;
            border: 4px solid #fff; /* ç™½è‰²é‚Šæ¡† */
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr; /* é è¨­ä¸€åˆ— */
            gap: 25px; /* å¢åŠ é¸é …é–“è· */
            width: 100%;
        }

        .option-button {
            background-color: #64b5f6; /* æ´»åŠ›è—è‰² */
            color: white;
            border: none;
            padding: 25px 35px; /* å¢å¤§æŒ‰éˆ•å¤§å° */
            border-radius: 15px; /* æ›´åœ“æ½¤ */
            font-size: 1.8em; /* å¢å¤§é¸é …å­—é«” */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            word-wrap: break-word;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* æŒ‰éˆ•é™°å½± */
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase; /* å¤§å¯«ï¼Œæ›´å…·éŠæˆ²æ„Ÿ */
        }

        .option-button:hover:not(:disabled) {
            background-color: #2196f3; /* ç•¥æ·±è—è‰² */
            transform: translateY(-7px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.35);
        }

        .option-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .option-button:disabled {
            opacity: 0.6; /* ç¦ç”¨æ™‚æ›´é€æ˜ */
            cursor: not-allowed;
        }

        .option-button.correct {
            background-color: #4caf50; /* ç¶ è‰²ï¼Œè¡¨ç¤ºæ­£ç¢º */
            animation: bounceIn 0.6s ease-out forwards; /* ç­”å°å‹•ç•« */
        }

        .option-button.wrong {
            background-color: #ff5722; /* æ´»åŠ›æ©˜ç´…è‰²ï¼Œè¡¨ç¤ºéŒ¯èª¤ */
            animation: shake 0.4s ease-in-out; /* ç­”éŒ¯å‹•ç•« */
        }

        /* å¡«å……é¡Œè¼¸å…¥æ¡†æ¨£å¼ */
        #fill-in-input {
            width: 80%;
            padding: 22px;
            border: 4px solid #a0c4ff;
            border-radius: 15px;
            font-size: 2em;
            text-align: center;
            margin-top: 25px;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.1);
            transition: border-color 0.3s ease;
            font-weight: bold;
            color: #333;
        }
        #fill-in-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.1), 0 0 15px rgba(0,123,255,0.5); /* èšç„¦æ™‚ç™¼å…‰ */
        }
        #fill-in-submit-button {
            margin-top: 30px;
            background-color: #28a745; /* ç¶ è‰² */
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 1.8em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        #fill-in-submit-button:hover {
            background-color: #218838;
            transform: translateY(-5px);
            box-shadow: 0 9px 18px rgba(0,0,0,0.3);
        }

        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        .feedback-text {
            font-size: 1.8em;
            margin-top: 30px;
            font-weight: bold;
            color: #e91e63; /* é†’ç›®çš„ç²‰è‰² */
            min-height: 40px;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .controls {
            margin-top: 40px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 25px; /* å¢åŠ æŒ‰éˆ•é–“è· */
        }

        .btn {
            color: white;
            border: none;
            padding: 20px 40px; /* å¢å¤§æŒ‰éˆ•å¤§å° */
            border-radius: 12px;
            font-size: 1.8em; /* å¢å¤§æŒ‰éˆ•å­—é«” */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            min-width: 200px; /* ç¢ºä¿æŒ‰éˆ•æœ‰æœ€å°å¯¬åº¦ */
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 9px 18px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn.primary-btn {
            background-color: #007bff; /* è—è‰²ï¼Œä¸»è¦è¡Œå‹• */
        }
        .btn.primary-btn:hover { background-color: #0056b3; }

        .btn.success-btn {
            background-color: #28a745; /* ç¶ è‰²ï¼ŒæˆåŠŸæˆ–å‰é€² */
        }
        .btn.success-btn:hover { background-color: #218838; }

        .btn.danger-btn {
            background-color: #dc3545; /* ç´…è‰²ï¼Œå±éšªæˆ–é‡ç½® */
        }
        .btn.danger-btn:hover { background-color: #c82333; }

        .btn.submit-btn {
            background-color: #673ab7; /* ç´«è‰² */
        }
        .btn.submit-btn:hover { background-color: #512da8; }

        .btn.leaderboard-btn {
            background-color: #ff9800; /* æ©˜è‰² */
        }
        .btn.leaderboard-btn:hover { background-color: #fb8c00; }

        .btn.return-btn {
            background-color: #78909c; /* æ·ºç°è‰² */
        }
        .btn.return-btn:hover { background-color: #546e7a; }

        .hidden {
            display: none !important;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        /* æ’è¡Œæ¦œæ¨£å¼ */
        .leaderboard-container {
            border: 5px solid #ffb74d; /* æ›´æ¸…æ™°çš„æ©˜è‰²é‚Šæ¡† */
        }

        .leaderboard-container h2 {
            color: #ff9800;
            font-size: 3.2em; /* å¢å¤§å­—é«” */
            margin-bottom: 30px;
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .leaderboard-list li {
            background-color: #fff3e0;
            margin-bottom: 15px; /* å¢åŠ é–“è· */
            padding: 18px 30px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5em; /* å¢å¤§å­—é«” */
            border: 2px solid #ffcc80;
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
            font-weight: bold;
            animation: slideInLeft 0.5s ease-out forwards;
            opacity: 0;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .leaderboard-list li:nth-child(even) { animation-delay: 0.1s; }
        .leaderboard-list li:nth-child(odd) { animation-delay: 0.2s; }


        .leaderboard-list li:first-child {
            background: linear-gradient(to right, #ffd700, #ffc000); /* ç¬¬ä¸€åç‰¹åˆ¥è‰² - é‡‘è‰²æ¼¸è®Š */
            color: #8B4513; /* æ·±æ£•è‰²æ–‡å­— */
            border-color: #ffa500;
            box-shadow: 0 8px 16px rgba(0,0,0,0.25);
            font-size: 1.8em;
            transform: scale(1.05);
            transition: transform 0.3s;
        }
        .leaderboard-list li:first-child:hover { transform: scale(1.08); }

        .leaderboard-list li:nth-child(2) {
            background: linear-gradient(to right, #c0c0c0, #a9a9a9); /* ç¬¬äºŒåç‰¹åˆ¥è‰² - éŠ€è‰²æ¼¸è®Š */
            color: #333;
            border-color: #999;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        .leaderboard-list li:nth-child(3) {
            background: linear-gradient(to right, #cd7f32, #b85f26); /* ç¬¬ä¸‰åç‰¹åˆ¥è‰² - éŠ…è‰²æ¼¸è®Š */
            color: white;
            border-color: #a04e17;
            box-shadow: 0 5px 10px rgba(0,0,0,0.18);
        }

        .leaderboard-list li span:first-child {
            font-weight: bold;
            color: #d84315;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }
        .leaderboard-list li span:last-child {
            color: #00796b;
            font-size: 1.1em;
        }
        /* ç‰¹æ®Šè™•ç†å‰ä¸‰åçš„æ–‡å­—é¡è‰² */
        .leaderboard-list li:first-child span:first-child { color: #8B4513; }
        .leaderboard-list li:first-child span:last-child { color: #8B4513; }
        .leaderboard-list li:nth-child(2) span { color: #333; }
        .leaderboard-list li:nth-child(3) span { color: white; }


        /* æ¨¡å¼é¸æ“‡ä»‹é¢ (é¦–é ) */
        .level-selection-container {
            gap: 35px; /* å¢åŠ é–“è· */
            /* é¦–é å°ˆå±¬èƒŒæ™¯å’Œæ•ˆæœ */
            /* å¦‚æœæœ‰ images/main_bg.png æœƒä½¿ç”¨å®ƒï¼Œå¦å‰‡ä½¿ç”¨ CSS æ¼¸è®Š */
            /* background: url('images/main_bg.png') no-repeat center center/cover; */
            padding: 60px;
            border-radius: 40px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
            animation: fadeInScale 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            position: relative;
            overflow: hidden; /* ç¢ºä¿èƒŒæ™¯åœ–æ¡ˆä¸æº¢å‡º */
        }
        /* é¦–é èƒŒæ™¯ç–ŠåŠ å±¤ï¼Œå¢åŠ è³ªæ„Ÿ */
        .level-selection-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 100%);
            z-index: 2;
            pointer-events: none;
            border-radius: 40px;
        }

        .level-selection-container h1 {
            font-size: 5em; /* é¦–é æ¨™é¡Œæ›´å¤§ */
            margin-bottom: 50px;
            position: relative;
            z-index: 3;
            color: #fff; /* æ¨™é¡Œé¡è‰²å¯è®Šç‚ºç™½è‰²ä»¥é©æ‡‰èƒŒæ™¯ */
            -webkit-text-stroke: 2px #0056b3; /* æé‚Šå¢åŠ å°æ¯” */
        }
        .level-selection-container h2 {
            font-size: 3.5em;
            color: #f8f9fa; /* æ·ºè‰²å­—é«”ï¼Œæ›´å¥½çœ‹ */
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            margin-bottom: 40px;
            position: relative;
            z-index: 3;
        }

        .mode-button, .level-button {
            background-color: #1e88e5; /* è—è‰²ç³» */
            color: white;
            border: none;
            padding: 28px 55px; /* å¢å¤§æŒ‰éˆ•å¤§å° */
            border-radius: 18px; /* æ›´åœ“æ½¤ */
            font-size: 2.5em; /* å¢å¤§å­—é«” */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 10px 20px rgba(0,0,0,0.35);
            width: 80%; /* è®“æŒ‰éˆ•å¯¬åº¦ä¸€è‡´ */
            max-width: 400px;
            font-weight: bold;
            letter-spacing: 1.5px;
            position: relative;
            z-index: 3;
            background: linear-gradient(45deg, #42a5f5, #1976d2); /* æŒ‰éˆ•æ¼¸è®Šè‰² */
            border: 2px solid #64b5f6;
        }
        .mode-button:hover, .level-button:hover {
            background-color: #1565c0;
            transform: translateY(-8px) scale(1.02); /* æ›´å¤§çš„ä¸Šç§»å’Œå¾®ç¸®æ”¾æ•ˆæœ */
            box-shadow: 0 15px 30px rgba(0,0,0,0.45);
            background: linear-gradient(45deg, #1976d2, #42a5f5); /* hover æ™‚é¡è‰²åå‘ */
            border-color: #2196f3;
        }

        /* å¤šäººå°æˆ°å¤§å»³ */
        .multiplayer-lobby {
            border: 5px solid #a0c4ff;
        }
        .lobby-controls {
            gap: 25px;
            margin-bottom: 40px;
        }
        #playerNameInput {
            padding: 18px 25px;
            border: 3px solid #a0c4ff;
            border-radius: 12px;
            font-size: 1.6em;
            width: calc(100% - 50px); /* è€ƒæ…® padding */
            max-width: 350px;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.1);
            font-weight: bold;
        }

        .room-list-container {
            background-color: #f0f8ff;
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #bbdefb;
            max-height: 400px; /* é™åˆ¶é«˜åº¦ï¼Œå¯æ»¾å‹• */
            overflow-y: auto; /* å…è¨±æ»¾å‹• */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.08);
        }
        #availableRoomsList li {
            background-color: #e3f2fd;
            margin-bottom: 15px;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 1.4em;
            border: 2px solid #90caf9;
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }
        #availableRoomsList li:hover {
            transform: translateX(5px);
        }

        #availableRoomsList li button {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        #availableRoomsList li button:hover {
            background-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

        /* éŠæˆ²æˆ¿é–“ä»‹é¢ */
        .game-room-container {
            border: 5px solid #a0c4ff;
        }
        .game-room-container .players-info {
            margin-bottom: 35px;
            font-size: 1.6em;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .game-room-container .players-info p {
            background-color: #e0f2f7;
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid #b2ebf2;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            font-weight: bold;
        }
        #room-status-message {
            font-size: 1.8em;
            margin-bottom: 30px;
            color: #e91e63;
            font-weight: bold;
        }

        /* è™›æ“¬è§’è‰²å€å¡Š */
        .mascot-area {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 200px; /* å¢å¤§è§’è‰² */
            height: 230px;
            z-index: 2;
            pointer-events: none;
            animation: bounceMascot 3s infinite ease-in-out;
        }

        .mascot-area img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(10px 10px 20px rgba(0,0,0,0.4)); /* æ›´æ˜é¡¯çš„é™°å½± */
        }

        @keyframes bounceMascot {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* è™›æ“¬è§’è‰²è¡¨æƒ…æ–‡å­—æ³¡æ³¡ */
        .mascot-speech-bubble {
            position: absolute;
            top: -70px; /* æ ¹æ“šåœ–ç‰‡èª¿æ•´ä½ç½® */
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffeb3b; /* é®®é»ƒè‰²æ³¡æ³¡ */
            border: 4px solid #fbc02d; /* æ›´æ˜é¡¯çš„é‚Šæ¡† */
            border-radius: 25px; /* æ›´åœ“æ½¤ */
            padding: 12px 18px;
            font-size: 1.3em;
            color: #333;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            pointer-events: none;
            z-index: 10;
            font-weight: bold;
            box-shadow: 0 5px 10px rgba(0,0,0,0.25);
            text-align: center;
        }
        .mascot-speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 30px;
            height: 30px;
            background-color: #ffeb3b;
            border-right: 4px solid #fbc02d;
            border-bottom: 4px solid #fbc02d;
            z-index: 1;
        }
        .mascot-speech-bubble.active {
            opacity: 1;
            transform: translateX(-50%) translateY(-20px); /* ç¨å¾®ä¸Šç§» */
        }

        /* é€£æ“Šæç¤º */
        .combo-streak {
            font-family: 'Noto Sans TC', sans-serif;
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 7em; /* å¢å¤§å­—é«” */
            color: #ffcc00;
            text-shadow: 6px 6px 12px rgba(0,0,0,0.7);
            -webkit-text-stroke: 4px #d4af37;
            pointer-events: none;
            z-index: 10;
            font-weight: 900;
            opacity: 0;
        }

        @keyframes comboPop {
            0% { transform: translate(-50%, 20px) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, 0px) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, 0px) scale(1); opacity: 0.9; }
        }


        /* RWD èª¿æ•´ */
        @media (min-width: 768px) {
            .options-container {
                grid-template-columns: 1fr 1fr; /* å…©åˆ— */
            }
        }

        @media (max-width: 992px) {
            .main-card {
                padding: 40px;
                border-radius: 30px;
            }
            h1 { font-size: 4em; margin-bottom: 35px; }
            h2 { font-size: 2.5em; margin-bottom: 25px; }
            .header-info { margin-bottom: 30px; }
            .score-area, .timer-area { font-size: 1.8em; padding: 10px 20px; min-width: 160px; }
            .question-area { padding: 35px; margin-bottom: 35px; min-height: 220px; }
            #question-text { font-size: 2.2em; margin-bottom: 25px; }
            #question-image { max-height: 200px; }
            .option-button { font-size: 1.6em; padding: 20px 30px; border-radius: 12px; }
            #fill-in-input { font-size: 1.8em; padding: 18px; border-radius: 12px; }
            #fill-in-submit-button { font-size: 1.6em; padding: 18px 35px; border-radius: 10px; }
            .feedback-text { font-size: 1.6em; margin-top: 25px; min-height: 35px; }
            .controls { margin-top: 35px; gap: 20px; }
            .btn { font-size: 1.6em; padding: 18px 35px; border-radius: 10px; min-width: 180px; }
            .leaderboard-list li { font-size: 1.3em; padding: 15px 25px; border-radius: 10px; }
            .leaderboard-list li:first-child { font-size: 1.5em; }
            .level-selection-container { padding: 50px; border-radius: 35px; }
            .level-selection-container h1 { font-size: 4.5em; margin-bottom: 40px; }
            .level-selection-container h2 { font-size: 3em; margin-bottom: 30px; }
            .mode-button, .level-button { font-size: 2.2em; padding: 25px 50px; border-radius: 15px; max-width: 380px; }
            #playerNameInput { font-size: 1.4em; padding: 15px 20px; }
            #availableRoomsList li { font-size: 1.25em; padding: 18px 25px; border-radius: 12px; }
            #availableRoomsList li button { padding: 12px 20px; }
            .game-room-container .players-info { font-size: 1.4em; gap: 15px; }
            #room-status-message { font-size: 1.6em; margin-bottom: 25px; }
            .mascot-area { width: 180px; height: 210px; bottom: 25px; left: 25px; }
            .mascot-speech-bubble { font-size: 1.2em; top: -60px; padding: 10px 15px; border-radius: 20px; }
            .combo-streak { font-size: 6em; }
        }

        @media (max-width: 767px) {
            body { font-size: 14px; }
            .main-card {
                padding: 30px;
                border-radius: 25px;
            }
            h1 { font-size: 3.5em; margin-bottom: 30px; }
            h2 { font-size: 2em; margin-bottom: 20px; }
            .header-info { flex-direction: column; gap: 15px; margin-bottom: 25px; }
            .score-area, .timer-area { width: 100%; max-width: 250px; font-size: 1.5em; padding: 8px 15px; }
            .question-area { padding: 25px; margin-bottom: 25px; min-height: 180px; }
            #question-text { font-size: 1.8em; margin-bottom: 20px; min-height: 120px; }
            #question-image { max-height: 150px; }
            .options-container { grid-template-columns: 1fr; gap: 15px; }
            .option-button { font-size: 1.3em; padding: 15px 20px; border-radius: 10px; }
            #fill-in-input { font-size: 1.5em; padding: 12px; border-radius: 10px; }
            #fill-in-submit-button { font-size: 1.3em; padding: 12px 25px; border-radius: 8px; }
            .feedback-text { font-size: 1.4em; margin-top: 20px; min-height: 30px; }
            .controls { margin-top: 30px; gap: 15px; }
            .btn { font-size: 1.3em; padding: 15px 25px; border-radius: 8px; min-width: 150px; }
            .leaderboard-list li { font-size: 1.2em; padding: 12px 20px; border-radius: 8px; }
            .leaderboard-list li:first-child { font-size: 1.4em; }
            .level-selection-container { padding: 40px; border-radius: 30px; }
            .level-selection-container h1 { font-size: 3.5em; margin-bottom: 35px; }
            .level-selection-container h2 { font-size: 2.5em; margin-bottom: 30px; }
            .mode-button, .level-button { font-size: 2em; padding: 20px 40px; border-radius: 12px; max-width: 350px; }
            #playerNameInput { font-size: 1.2em; padding: 15px 20px; }
            #availableRoomsList li { font-size: 1.1em; padding: 15px 20px; border-radius: 12px; }
            #availableRoomsList li button { padding: 10px 15px; }
            .game-room-container .players-info { font-size: 1.2em; gap: 10px; }
            #room-status-message { font-size: 1.4em; margin-bottom: 20px; }
            .mascot-area { width: 150px; height: 170px; bottom: 20px; left: 20px; }
            .mascot-speech-bubble { font-size: 1.1em; top: -55px; padding: 8px 12px; border-radius: 18px; }
            .combo-streak { font-size: 5em; }
        }

        @media (max-width: 480px) {
            body { font-size: 12px; }
            .main-card {
                padding: 20px;
                border-radius: 20px;
            }
            h1 { font-size: 3em; margin-bottom: 25px; }
            h2 { font-size: 1.8em; margin-bottom: 15px; }
            .header-info { gap: 10px; margin-bottom: 20px; }
            .score-area, .timer-area { font-size: 1.3em; padding: 6px 12px; }
            .question-area { padding: 20px; margin-bottom: 20px; min-height: 150px; }
            #question-text { font-size: 1.6em; margin-bottom: 15px; min-height: 100px; }
            #question-image { max-height: 120px; }
            .option-button { font-size: 1.1em; padding: 12px 15px; border-radius: 8px; }
            #fill-in-input { font-size: 1.3em; padding: 10px; border-radius: 8px; }
            #fill-in-submit-button { font-size: 1.1em; padding: 10px 20px; border-radius: 6px; }
            .feedback-text { font-size: 1.2em; margin-top: 15px; min-height: 25px; }
            .controls { margin-top: 25px; gap: 10px; }
            .btn { font-size: 1.1em; padding: 12px 20px; border-radius: 6px; min-width: 120px; }
            .leaderboard-list li { font-size: 1em; padding: 10px 15px; border-radius: 6px; }
            .leaderboard-list li:first-child { font-size: 1.2em; }
            .level-selection-container { padding: 30px; border-radius: 25px; }
            .level-selection-container h1 { font-size: 3em; margin-bottom: 30px; }
            .level-selection-container h2 { font-size: 2.2em; margin-bottom: 20px; }
            .mode-button, .level-button { font-size: 1.8em; padding: 18px 35px; border-radius: 10px; max-width: 300px; }
            #playerNameInput { font-size: 1em; padding: 10px 15px; }
            #availableRoomsList li { font-size: 0.95em; padding: 12px 15px; border-radius: 8px; }
            #availableRoomsList li button { padding: 8px 12px; }
            .game-room-container .players-info { font-size: 1em; gap: 8px; }
            #room-status-message { font-size: 1.2em; margin-bottom: 15px; }
            .mascot-area { width: 120px; height: 140px; bottom: 15px; left: 15px; }
            .mascot-speech-bubble { font-size: 1em; top: -45px; padding: 6px 10px; border-radius: 15px; }
            .combo-streak { font-size: 4em; }
        }

    </style>
</head>
<body>
    <audio id="correctSound" src="sounds/correct.mp3" preload="auto"></audio>
    <audio id="wrongSound" src="sounds/wrong.mp3" preload="auto"></audio>
    <audio id="timeWarningSound" src="sounds/time_warning.mp3" preload="auto"></audio>
    <audio id="backgroundMusic" src="sounds/bg_music.mp3" loop preload="auto"></audio>

    <div class="mascot-area">
        <img id="mascotImage" src="images/mascot_neutral.png" alt="å®¢å®¶å°ç²¾éˆ">
        <div id="mascotSpeechBubble" class="mascot-speech-bubble"></div>
    </div>

    <div id="comboStreakDisplay" class="combo-streak hidden"></div>

    <div class="main-card level-selection-container" id="levelSelectionContainer">
        <h1>å®¢èªèªè­‰è€ƒé¡Œå°å°ç¢°</h1>
        <h2>æ­¡è¿ä¾†åˆ°å®¢èªçš„ä¸–ç•Œï¼</h2>
        <p style="font-size: 1.5em; color: #5a5a5a; margin-bottom: 30px; line-height: 1.8;">
            é€éè¼•é¬†æœ‰è¶£çš„éŠæˆ²ï¼Œå­¸ç¿’å®¢å®¶å–®å­—ã€è©å½™å’Œè«ºèªã€‚<br>
            æŒ‘æˆ°è‡ªå·±ï¼Œæˆç‚ºå®¢èªå¤§å¸«å§ï¼
        </p>
        <div class="controls" style="margin-top: 0;">
            <button class="mode-button" data-mode="single">å–®äººæŒ‘æˆ°</button>
            <button class="mode-button" data-mode="multi">å¤šäººå°æˆ°</button>
            <button id="show-leaderboard-initial" class="btn leaderboard-btn">æŸ¥çœ‹å®¢èªå¤§å¸«æ¦œ</button>
        </div>
    </div>

    <div class="main-card game-container hidden" id="gameContainer">
        <div class="header-info">
            <div class="score-area">åˆ†æ•¸: <span id="score">0</span> / <span id="totalQuestions">10</span></div>
            <div class="timer-area">å€’æ•¸: <span id="timer">30</span> ç§’</div>
        </div>

        <div class="question-area">
            <div id="question-text"></div>
            <img id="question-image" src="" alt="é¡Œç›®åœ–ç‰‡" class="hidden">
            <div class="options-container" id="optionsContainer">
                </div>
            <div id="fillInContainer" class="fill-in-container hidden">
                <input type="text" id="fill-in-input" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ">
                <button id="fill-in-submit-button" class="btn success-btn">æäº¤ç­”æ¡ˆ</button>
            </div>
        </div>

        <div class="feedback-text" id="feedbackText"></div>

        <div class="controls">
            <button id="nextButton" class="btn success-btn hidden">ä¸‹ä¸€é¡Œ</button>
            <button id="restartButton" class="btn primary-btn hidden">é‡æ–°é–‹å§‹</button>
            <button id="submitScoreButton" class="btn submit-btn hidden">æäº¤åˆ†æ•¸åˆ°æ’è¡Œæ¦œ</button>
            <button id="showLeaderboardGameEndButton" class="btn leaderboard-btn hidden">æŸ¥çœ‹ç¸½æ’è¡Œæ¦œ</button>
            <button id="returnToModeSelectionFromGame" class="btn return-btn hidden">è¿”å›æ¨¡å¼é¸æ“‡</button>
        </div>
    </div>

    <div class="main-card multiplayer-lobby hidden" id="multiplayerLobby">
        <h1>å¤šäººå°æˆ°å¤§å»³</h1>
        <p style="font-size: 1.4em; color: #666; margin-bottom: 30px;">
            å’Œä½ çš„æœ‹å‹ä¸€èµ·æŒ‘æˆ°å®¢èªå§ï¼
        </p>
        <div class="lobby-controls controls" style="margin-top: 0;">
            <input type="text" id="playerNameInput" placeholder="è¼¸å…¥ä½ çš„åå­—" value="ç©å®¶">
            <button id="createRoomBtn" class="btn success-btn">å‰µå»ºæˆ¿é–“</button>
            <button id="joinRoomBtn" class="btn primary-btn">åŠ å…¥æˆ¿é–“</button>
            <button id="refreshRoomsBtn" class="btn leaderboard-btn">åˆ·æ–°æˆ¿é–“åˆ—è¡¨</button>
            <button id="returnToModeSelectionFromLobby" class="btn return-btn">è¿”å›æ¨¡å¼é¸æ“‡</button>
        </div>
        <div class="room-list-container">
            <h3>å¯ç”¨æˆ¿é–“åˆ—è¡¨ï¼š</h3>
            <ul id="availableRoomsList">
                </ul>
        </div>
    </div>

    <div class="main-card game-room-container hidden" id="gameRoomContainer">
        <h2>æˆ¿é–“ ID: <span id="currentRoomId"></span></h2>
        <div class="players-info">
            <p>ä½ çš„åå­—: <span id="myPlayerName"></span></p>
            <p>å°æ‰‹åå­—: <span id="opponentPlayerName"></span></p>
            <p>ä½ çš„åˆ†æ•¸: <span id="myPlayerScore">0</span></p>
            <p>å°æ‰‹åˆ†æ•¸: <span id="opponentPlayerScore">0</span></p>
        </div>
        <div id="room-status-message">ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥...</div>
        <button id="startGameInRoomBtn" class="btn success-btn hidden">é–‹å§‹éŠæˆ²</button>
        <button id="leaveRoomBtn" class="btn danger-btn hidden">é›¢é–‹æˆ¿é–“</button>
        </div>

    <div class="main-card leaderboard-container hidden" id="leaderboardContainer">
        <h2>ğŸ… å®¢èªå¤§å¸«æ¦œ ğŸ…</h2>
        <ul id="leaderboardList" class="leaderboard-list">
            </ul>
        <div class="controls">
            <button id="returnFromLeaderboard" class="btn return-btn">è¿”å›</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script> <script>
        // --- æ‚¨çš„ Firebase é…ç½®è³‡è¨Š ---
        const firebaseConfig = {
            apiKey: "AIzaSyCVvM_kfmLy68NK-ILq63me50Gn6ROiWJ8",
            authDomain: "snake-8bc6a.firebaseapp.com",
            databaseURL: "https://snake-8bc6a-default-rtdb.firebaseio.com",
            projectId: "snake-8bc6a",
            storageBucket: "snake-8bc6a.firebasestorage.app",
            messagingSenderId: "800157644026",
            appId: "1:800157644026:web:3b90c15789cacfef918543",
            measurementId: "G-NJ34S53TSV"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics(); // åˆå§‹åŒ– Analytics
        const db = firebase.firestore();

        // --- éŠæˆ²è¨­å®š ---
        const NUM_QUESTIONS_PER_GAME = 10;
        const TIME_PER_QUESTION = 30; // æ¯é¡Œç§’æ•¸
        const WARNING_TIME = 10; // å€’æ•¸è­¦å‘Šæ™‚é–“

        // --- DOM å…ƒç´  ---
        const gameContainer = document.getElementById('gameContainer');
        const levelSelectionContainer = document.getElementById('levelSelectionContainer');
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const multiplayerLobby = document.getElementById('multiplayerLobby');
        const gameRoomContainer = document.getElementById('gameRoomContainer');

        const scoreDisplay = document.getElementById('score');
        const totalQuestionsDisplay = document.getElementById('totalQuestions');
        const timerDisplay = document.getElementById('timer');
        const timerArea = document.querySelector('.timer-area');
        const questionText = document.getElementById('question-text');
        const questionImage = document.getElementById('question-image'); // æ–°å¢åœ–ç‰‡å…ƒç´ 
        const optionsContainer = document.getElementById('optionsContainer');
        const fillInContainer = document.getElementById('fillInContainer');
        const fillInInput = document.getElementById('fill-in-input');
        const fillInSubmitButton = document.getElementById('fill-in-submit-button');
        const feedbackText = document.getElementById('feedbackText');

        const nextButton = document.getElementById('nextButton');
        const restartButton = document.getElementById('restartButton');
        const submitScoreButton = document.getElementById('submitScoreButton');
        const showLeaderboardInitialButton = document.getElementById('show-leaderboard-initial');
        const showLeaderboardGameEndButton = document.getElementById('showLeaderboardGameEndButton');
        const returnFromLeaderboardButton = document.getElementById('returnFromLeaderboard');
        const leaderboardList = document.getElementById('leaderboardList');
        // --- ä¿®æ­£é» 1: ç¢ºä¿è¿”å›æ¨¡å¼é¸æ“‡çš„æŒ‰éˆ• ID å­˜åœ¨ä¸”å”¯ä¸€ ---
        const returnToModeSelectionFromGameButton = document.getElementById('returnToModeSelectionFromGame'); // å¾éŠæˆ²çµæŸè¿”å›
        const returnToModeSelectionFromLevelsButton = document.getElementById('returnToModeSelectionFromLevels'); // å¾é›£åº¦é¸æ“‡è¿”å› (æ­¤å…ƒç´ æ˜¯å‹•æ…‹å‰µå»ºçš„ï¼Œéœ€è¦èª¿æ•´ç›£è½æ–¹å¼)


        // å¤šäººå°æˆ°ç›¸é—œ DOM å…ƒç´ 
        const modeButtons = document.querySelectorAll('.mode-button'); // åŸä¾†çš„ modeButtons
        const playerNameInput = document.getElementById('playerNameInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const refreshRoomsBtn = document.getElementById('refreshRoomsBtn');
        const availableRoomsList = document.getElementById('availableRoomsList');
        const returnToModeSelectionFromLobbyBtn = document.getElementById('returnToModeSelectionFromLobby'); // å¾å¤šäººå¤§å»³è¿”å›

        const currentRoomIdDisplay = document.getElementById('currentRoomId');
        const myPlayerNameDisplay = document.getElementById('myPlayerName');
        const opponentPlayerNameDisplay = document.getElementById('opponentPlayerName');
        const myPlayerScoreDisplay = document.getElementById('myPlayerScore');
        const opponentPlayerScoreDisplay = document.getElementById('opponentPlayerScore');
        const roomStatusMessage = document.getElementById('room-status-message');
        const startGameInRoomBtn = document.getElementById('startGameInRoomBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');

        // éŸ³æ•ˆå…ƒç´ 
        const correctSound = document.getElementById('correctSound');
        const wrongSound = document.getElementById('wrongSound');
        const timeWarningSound = document.getElementById('timeWarningSound');
        const backgroundMusic = document.getElementById('backgroundMusic');

        // è™›æ“¬è§’è‰²å…ƒç´ 
        const mascotImage = document.getElementById('mascotImage');
        const mascotSpeechBubble = document.getElementById('mascotSpeechBubble');

        // é€£æ“Šæç¤ºå…ƒç´ 
        const comboStreakDisplay = document.getElementById('comboStreakDisplay');


        // --- éŠæˆ²è®Šæ•¸ ---
        let score = 0;
        let currentQuestionIndex = 0;
        let currentQuestions = [];
        let timerInterval;
        let timeLeft = TIME_PER_QUESTION;
        let selectedLevel = 'medium'; // é è¨­é›£åº¦

        let comboStreak = 0; // é€£æ“Šæ•¸

        // å¤šäººå°æˆ°ç›¸é—œè®Šæ•¸
        let currentMode = 'single'; // 'single' æˆ– 'multi'
        let currentRoomId = null;
        let myPlayerId = null; // æ¯å€‹ç©å®¶çš„å”¯ä¸€ ID
        let myPlayerName = 'ç©å®¶';
        let opponentPlayerId = null;
        let roomSnapshotListener = null; // ç”¨æ–¼å–æ¶ˆ Firestore ç›£è½

        // --- é¡Œåº«è³‡æ–™ ---
        // æ ¡å°å¾Œçš„é¡Œç›®ï¼Œç§»é™¤è½åŠ›é¡Œï¼Œå¢åŠ åœ–ç‰‡é¡Œå’Œå½¢å®¹è©çŒœå­—é¡Œ
        const allQuestions = [
            // åˆç´šé¡Œç›® (å–®å­—ç¿»è­¯)
            { type: 'multiple-choice', level: 'easy', question: "ã€Œä½ å¥½ã€ä¸ªå®¢èªæ€è¬›ï¼Ÿ", options: ["å¤šè¬", "ä½ å¥½", "å†è¦‹", "æ¯‹ä½¿æ„"], answer: 1 },
            { type: 'multiple-choice', level: 'easy', question: "ã€Œè¬è¬ã€ä¸ªå®¢èªæ€è¬›ï¼Ÿ", options: ["å¤šè¬", "ä½ å¥½", "æ‰¿è’™ä½ ", "æ¯‹æœƒ"], answer: 0 },
            { type: 'fill-in-the-blank', level: 'easy', question: "è«‹å¡«å¯«ã€Œä¸å®¢æ°£ã€ä¸ªå®¢èªï¼šæ¯‹ä½¿_______ã€‚", answer: "æ„" },
            { type: 'multiple-choice', level: 'easy', question: "ã€Œåƒé£¯ã€ä¸ªå®¢èªæ€è¬›ï¼Ÿ", options: ["é£Ÿé£¯", "é£ŸèŒ¶", "é£Ÿé»å¿ƒ", "é£Ÿéºµ"], answer: 0 },
            { type: 'multiple-choice', level: 'easy', question: "ã€Œå–æ°´ã€ä¸ªå®¢èªæ€è¬›ï¼Ÿ", options: ["é£Ÿæ°´", "å•‰æ°´", "é£²æ°´", "æ´—æ‰‹"], answer: 1 },
            { type: 'fill-in-the-blank', level: 'easy', question: "è«‹å¡«å¯«ã€Œå†è¦‹ã€ä¸ªå®¢èªï¼š_______ã€‚", answer: "å†è¦‹" },
            { type: 'multiple-choice', level: 'easy', question: "ã€Œæ—©ä¸Šå¥½ã€ä¸ªå®¢èªæ€è¬›ï¼Ÿ", options: ["æ—©å®‰", "ä¸‹æ™å¥½", "å¤œæ™¡å¥½", "æš—æ™¡å¤œå¥½"], answer: 0 },
            { type: 'multiple-choice', level: 'easy', question: "ã€Œç¡è¦ºã€ä¸ªå®¢èªæ€è¬›ï¼Ÿ", options: ["é£Ÿé£½", "ç¡ç›®", "è‘—è¡«", "æ´—èº«"], answer: 1 },
            { type: 'fill-in-the-blank', level: 'easy', question: "è«‹å¡«å¯«ã€ŒéŒ¢ã€ä¸ªå®¢èªï¼š_______ã€‚", answer: "éŒ¢" },
            { type: 'multiple-choice', level: 'easy', question: "ã€Œå›å®¶ã€ä¸ªå®¢èªæ€è¬›ï¼Ÿ", options: ["è½‰å±‹ä¸‹", "ä¸Šç­", "è®€æ›¸", "é‹å‹•"], answer: 0 },

            // ä¸­ç´šé¡Œç›® (è©èªå¡«ç©ºã€ç°¡å–®æè¿°çŒœå­—)
            { type: 'multiple-choice', level: 'medium', question: "ã€Œéº¼ä¸ªã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["ä»€éº¼", "å“ªè£¡", "å¤šå°‘", "å¦‚ä½•"], answer: 0 },
            { type: 'fill-in-the-blank', level: 'medium', question: "è«‹å¡«å¯«ã€Œæ¼‚äº®ã€ä¸ªå®¢èªï¼š_______éšã€‚", answer: "éš" },
            { type: 'multiple-choice', level: 'medium', question: "ã€Œæ¯‹è­˜ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["èªè­˜", "ä¸èªè­˜", "çŸ¥é“", "ä¸çŸ¥é“"], answer: 1 },
            { type: 'multiple-choice', level: 'medium', question: "ã€Œæéº¼ä¸ªã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["åšä»€éº¼", "æ€éº¼è¾¦", "ç‚ºä»€éº¼", "åœ¨å“ªè£¡"], answer: 0 },
            { type: 'fill-in-the-blank', level: 'medium', question: "è«‹å¡«å¯«ã€Œé–‹å¿ƒã€ä¸ªå®¢èªï¼šæ­¡_______ã€‚", answer: "å–œ" },
            { type: 'multiple-choice', level: 'medium', question: "ã€Œé‘Šå«²ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["é‹å­", "ç¢—", "ç­·å­", "ç›¤å­"], answer: 0 },
            { type: 'multiple-choice', level: 'medium', question: "ã€Œæ—¥é ­ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["æœˆäº®", "å¤ªé™½", "æ˜Ÿæ˜Ÿ", "é›²æœµ"], answer: 1 },
            { type: 'fill-in-the-blank', level: 'medium', question: "è«‹å¡«å¯«ã€Œå®¢äººã€ä¸ªå®¢èªï¼š_______äººã€‚", answer: "å®¢" },
            { type: 'multiple-choice', level: 'medium', question: "ã€Œæ¯‹å¥½æ„æ€ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["å°ä¸èµ·", "æ²’é—œä¿‚", "è«‹", "è¬è¬"], answer: 0 },
            { type: 'fill-in-the-blank', level: 'medium', question: "è«‹å¡«å¯«ã€Œå­¸æ ¡ã€ä¸ªå®¢èªï¼šå­¸_______ã€‚", answer: "æ ¡" },
            { type: 'image-choice', level: 'medium', image: 'images/flower.png', question: "è«‹çœ‹åœ–ç‰‡ï¼Œé¸æ“‡å®¢èªä¸­ã€ŒèŠ±ã€çš„èªªæ³•ï¼š", options: ["ç«¹", "æ¨¹", "èŠ±", "è‰"], answer: 2 }, // å‡è¨­æ‚¨æœ‰ `images/flower.png`
            { type: 'description-fill-in', level: 'medium', question: "å½¢å®¹ä¸€å€‹äººã€Œå¾ˆç˜¦ã€ï¼Œå®¢èªæœƒèªªã€Œæ‰¿_______ã€ã€‚", answer: "ç˜¦" },

            // é«˜ç´šé¡Œç›® (è«ºèªå¡«ç©ºã€åœ–ç‰‡é¡Œã€å½¢å®¹è©çŒœå­—)
            { type: 'multiple-choice', level: 'hard', question: "ã€Œç¦¾åŸ•ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["æ›¬ç©€å ´", "å®¢å»³", "å»šæˆ¿", "è‡¥å®¤"], answer: 0 }, // ä¿®æ­£ç¿»è­¯
            { type: 'fill-in-the-blank', level: 'hard', question: "ã€Œé ­æ“ºã€åœ¨å®¢èªä¸­æ˜¯æŒ‡ã€Œ_______ä»¥å‰ã€ã€‚", answer: "å¾ˆä¹…" },
            { type: 'multiple-choice', level: 'hard', question: "ã€Œç´°äººä»”ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["å¤§äºº", "å°å­©", "è€äºº", "é’å¹´"], answer: 1 },
            { type: 'multiple-choice', level: 'hard', question: "ã€Œæ­£ç¶“ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["çœŸçš„", "å‡çš„", "å¯èƒ½", "ä¹Ÿè¨±"], answer: 0 },
            { type: 'fill-in-the-blank', level: 'hard', question: "ã€Œæ‰“å¹«æ‰‹ã€åœ¨å®¢èªä¸­æ˜¯æŒ‡ã€Œ_______å¿™ã€ã€‚", answer: "å¹«" },
            { type: 'multiple-choice', level: 'hard', question: "ã€Œé½é½ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["æ…¢æ…¢åœ°", "å¿«é»", "å®‰éœåœ°", "å¤§è²åœ°"], answer: 1 },
            { type: 'fill-in-the-blank', level: 'hard', question: "ã€Œç‡¥æ¯‹ç‡¥ã€åœ¨å®¢èªä¸­æ˜¯å•ã€Œ_______ä¸_______ã€ã€‚", answer: "ç†±ä¸ç†±" },
            { type: 'multiple-choice', level: 'hard', question: "ã€Œç®¸ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["æ¹¯åŒ™", "ç¢—", "ç­·å­", "ç›¤å­"], answer: 2 },
            { type: 'fill-in-the-blank', level: 'hard', question: "ã€Œé£Ÿé£½é£¯ã€ä¸ªå®¢èªæ˜¯ã€Œ_______é£½é£¯ã€ã€‚", answer: "é£Ÿ" },
            { type: 'multiple-choice', level: 'hard', question: "ã€Œæ’–ã€åœ¨å®¢èªä¸­æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", options: ["å¾ˆ", "åƒ", "åš", "èµ°"], answer: 0 },
            { type: 'image-choice', level: 'hard', image: 'images/mountain.png', question: "çœ‹åˆ°é€™å¼µåœ–ç‰‡ï¼Œè«‹é¸æ“‡å®¢èªä¸­ã€Œå±±ã€çš„èªªæ³•ï¼š", options: ["æ°´", "ç”°", "å±±", "è·¯"], answer: 2 }, // å‡è¨­æ‚¨æœ‰ `images/mountain.png`
            { type: 'description-fill-in', level: 'hard', question: "å½¢å®¹ä¸€å€‹äººã€Œå¾ˆæœƒèªªè©±/å¾ˆèƒ½èªªã€ï¼Œå®¢èªæœƒèªªã€Œè¬›åˆ°å‡º_______ã€ã€‚", answer: "èŠ±" }, // è¬›åˆ°å‡ºèŠ± - å½¢å®¹å£æ‰å¥½ï¼Œèªªè©±èŠ±ä¿å‹•è½
        ];

        // --- å‡½æ•¸å®šç¾© ---

        // ç”Ÿæˆéš¨æ©Ÿé¡Œç›®
        function getRandomQuestions(num, level) {
            const filteredQuestions = allQuestions.filter(q => q.level === level);
            const shuffled = filteredQuestions.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, num);
        }

        // å•Ÿå‹•è¨ˆæ™‚å™¨ (å–®äººæ¨¡å¼å°ˆç”¨)
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = TIME_PER_QUESTION;
            timerDisplay.textContent = timeLeft;
            timerArea.classList.remove('time-low'); // ç§»é™¤è­¦å‘Šæ¨£å¼
            timerInterval = setInterval(updateTimer, 1000);
        }

        // æ›´æ–°è¨ˆæ™‚å™¨ (å–®äººæ¨¡å¼å°ˆç”¨)
        function updateTimer() {
            timerDisplay.textContent = timeLeft;
            if (timeLeft <= WARNING_TIME && timeLeft > 0) {
                timerArea.classList.add('time-low');
                playSound(timeWarningSound); // æ™‚é–“å¿«çµæŸæ™‚æ’­æ”¾è­¦å‘ŠéŸ³
            } else if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerArea.classList.add('time-low');
                feedbackText.textContent = 'æ™‚é–“åˆ°äº†ï¼';
                disableControls();
                nextButton.classList.remove('hidden');
                comboStreak = 0; // æ™‚é–“åˆ°ï¼Œé€£æ“Šæ­¸é›¶
                showMascotSpeech("æ™‚é–“åˆ°å›‰ï¼ä¸‹æ¬¡åæ‡‰å¿«ä¸€é»ï¼", 1500, 'images/mascot_sad.png'); // æ™‚é–“åˆ°ï¼Œå°ç²¾éˆæç¤º
                comboStreakDisplay.classList.add('hidden');
            }
            timeLeft--;
        }

        // å•Ÿç”¨æ§åˆ¶é …
        function enableControls() {
            Array.from(optionsContainer.children).forEach(button => {
                button.disabled = false;
                button.classList.remove('correct', 'wrong'); // æ¸…é™¤ä¸Šæ¬¡çš„ç­”æ¡ˆé¡è‰²
            });
            fillInInput.disabled = false;
            fillInSubmitButton.disabled = false;
            fillInInput.style.borderColor = '#a0c4ff'; // é‡ç½®é‚Šæ¡†é¡è‰²
        }

        // ç¦ç”¨æ§åˆ¶é …
        function disableControls() {
            Array.from(optionsContainer.children).forEach(button => {
                button.disabled = true;
            });
            fillInInput.disabled = true;
            fillInSubmitButton.disabled = true;
            fillInInput.style.borderColor = '#ccc'; // ç¦ç”¨æ™‚è®Šç°
        }

        // éŸ³æ•ˆæ’­æ”¾å‡½æ•¸
        function playSound(soundElement) {
            if (soundElement) {
                soundElement.currentTime = 0; // å¾é ­æ’­æ”¾
                soundElement.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e));
            }
        }

        // è™›æ“¬è§’è‰²äº’å‹•å‡½æ•¸
        function showMascotSpeech(message, duration = 2000, imageSrc = 'images/mascot_neutral.png') {
            mascotSpeechBubble.textContent = message;
            mascotImage.src = imageSrc; // æ ¹æ“šæƒ…ç·’æ”¹è®Šåœ–ç‰‡

            mascotSpeechBubble.classList.add('active');
            clearTimeout(mascotSpeechBubble.timer);
            mascotSpeechBubble.timer = setTimeout(() => {
                mascotSpeechBubble.classList.remove('active');
                mascotImage.src = 'images/mascot_neutral.png'; // å›å¾©ä¸­æ€§è¡¨æƒ…
            }, duration);
        }

        // é€£æ“Šé¡¯ç¤ºå‡½æ•¸
        function showComboStreak() {
            if (comboStreak > 1) { // è‡³å°‘2é€£æ“Šæ‰é¡¯ç¤º
                comboStreakDisplay.textContent = `${comboStreak} é€£æ“Šï¼`;
                comboStreakDisplay.classList.remove('hidden');
                // è§¸ç™¼å‹•ç•«
                comboStreakDisplay.style.animation = 'none'; // é‡ç½®å‹•ç•«
                void comboStreakDisplay.offsetWidth; // è§¸ç™¼é‡ç¹ª
                comboStreakDisplay.style.animation = 'comboPop 0.8s ease-out forwards';

                clearTimeout(comboStreakDisplay.timer);
                comboStreakDisplay.timer = setTimeout(() => {
                    comboStreakDisplay.classList.add('hidden');
                }, 1000); // é¡¯ç¤º1ç§’
            } else {
                comboStreakDisplay.classList.add('hidden');
            }
        }


        // å–®äººæ¨¡å¼çš„è¼‰å…¥é¡Œç›®
        function loadQuestionSinglePlayer() {
            optionsContainer.innerHTML = '';
            fillInContainer.classList.add('hidden');
            fillInInput.value = '';
            feedbackText.textContent = '';
            questionImage.classList.add('hidden'); // éš±è—åœ–ç‰‡
            questionImage.src = ''; // æ¸…ç©ºåœ–ç‰‡æº

            // ç¢ºä¿èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾ (å¦‚æœé‚„æ²’æ’­æ”¾)
            if (backgroundMusic.paused) {
                backgroundMusic.play().catch(e => console.log("èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å¤±æ•—:", e));
            }

            if (currentQuestionIndex < currentQuestions.length) {
                startTimer(); // å–®äººæ¨¡å¼ä½¿ç”¨æœ¬åœ°è¨ˆæ™‚

                const q = currentQuestions[currentQuestionIndex];
                questionText.textContent = q.question;

                if (q.image) { // å¦‚æœæ˜¯åœ–ç‰‡é¡Œ
                    questionImage.src = q.image;
                    questionImage.classList.remove('hidden');
                }

                if (q.type === 'multiple-choice' || q.type === 'image-choice') {
                    optionsContainer.classList.remove('hidden');
                    optionsContainer.style.display = 'grid';
                    q.options.forEach((option, index) => {
                        const button = document.createElement('button');
                        button.classList.add('option-button');
                        button.textContent = option;
                        button.dataset.index = index;
                        button.addEventListener('click', () => checkAnswerSinglePlayer(button, index, q.answer, q.type));
                        optionsContainer.appendChild(button);
                    });
                } else if (q.type === 'fill-in-the-blank' || q.type === 'description-fill-in') {
                    optionsContainer.classList.add('hidden');
                    fillInContainer.classList.remove('hidden');
                    fillInInput.focus();
                    fillInSubmitButton.onclick = () => checkAnswerSinglePlayer(null, fillInInput.value.trim(), q.answer, q.type);
                    fillInInput.onkeydown = (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            fillInSubmitButton.click();
                        }
                    };
                }
                nextButton.classList.add('hidden');
                enableControls(); // å•Ÿç”¨æ§åˆ¶é …
                showMascotSpeech("åŠ æ²¹ï¼çœ‹ä½ çš„äº†ï¼", 1500); // æ¯æ¬¡å‡ºé¡Œéƒ½è®“å°ç²¾éˆèªªè©±
            } else {
                // éŠæˆ²çµæŸ
                clearInterval(timerInterval);
                timerArea.classList.add('hidden');
                questionText.innerHTML = `éŠæˆ²çµæŸï¼æ‚¨çš„åˆ†æ•¸æ˜¯ ${score} / ${currentQuestions.length}ã€‚æ‰¿è’™æ‚¨ä¸ªåƒèˆ‡ï¼<br><small>æƒ³çŸ¥é“æ‚¨çš„æˆç¸¾åœ¨æ’è¡Œæ¦œä¸Šçš„è¡¨ç¾å—ï¼Ÿ</small>`;
                optionsContainer.innerHTML = '';
                fillInContainer.classList.add('hidden');
                feedbackText.textContent = '';
                nextButton.classList.add('hidden');
                restartButton.classList.remove('hidden');
                submitScoreButton.classList.remove('hidden');
                showLeaderboardGameEndButton.classList.remove('hidden');
                returnToModeSelectionFromGameButton.classList.remove('hidden'); // ç¢ºä¿é€™å€‹æŒ‰éˆ•é¡¯ç¤ºå‡ºä¾†

                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;

                if (score / currentQuestions.length > 0.8) {
                    showMascotSpeech("å¤ªæ£’äº†ï¼æ‚¨æ˜¯å®¢èªå°å¤©æ‰ï¼", 3000, 'images/mascot_happy.png');
                } else if (score / currentQuestions.length > 0.5) {
                    showMascotSpeech("è¡¨ç¾ä¸éŒ¯å–”ï¼ç¹¼çºŒåŠªåŠ›ï¼", 3000, 'images/mascot_smile.png');
                } else {
                    showMascotSpeech("åˆ¥ç°å¿ƒï¼Œå¤šç·´ç¿’å°±é€²æ­¥äº†ï¼", 3000, 'images/mascot_sad.png');
                }
            }
        }

        // å–®äººæ¨¡å¼çš„æª¢æŸ¥ç­”æ¡ˆ
        function checkAnswerSinglePlayer(clickedElement, selectedValue, correctAnswer, type) {
            clearInterval(timerInterval);
            disableControls();

            let isCorrect = false;
            let actualCorrectAnswer = '';

            if (type === 'multiple-choice' || type === 'image-choice') {
                if (selectedValue === correctAnswer) {
                    isCorrect = true;
                }
                actualCorrectAnswer = currentQuestions[currentQuestionIndex].options[correctAnswer];
                if (clickedElement) {
                    clickedElement.classList.add(isCorrect ? 'correct' : 'wrong');
                    if (!isCorrect) {
                        Array.from(optionsContainer.children).forEach(button => {
                            if (parseInt(button.dataset.index) === correctAnswer) {
                                button.classList.add('correct');
                            }
                        });
                    }
                }
            } else if (type === 'fill-in-the-blank' || type === 'description-fill-in') {
                // å°‡ä½¿ç”¨è€…è¼¸å…¥çš„ç­”æ¡ˆå’Œæ­£ç¢ºç­”æ¡ˆéƒ½è½‰æ›ç‚ºå°å¯«è‹±æ–‡ï¼Œä¸¦ç§»é™¤æ‰€æœ‰éä¸­æ–‡å­—å…ƒï¼Œä»¥é€²è¡Œæ›´å¯¬é¬†çš„åŒ¹é…
                const normalizedSelected = String(selectedValue).toLowerCase().replace(/[^\u4e00-\u9fa5a-z0-9]/g, '');
                const normalizedCorrect = String(correctAnswer).toLowerCase().replace(/[^\u4e00-\u9fa5a-z0-9]/g, '');
                isCorrect = (normalizedSelected === normalizedCorrect);
                actualCorrectAnswer = correctAnswer;
                fillInInput.disabled = true;
                fillInSubmitButton.disabled = true;
                if (isCorrect) {
                    fillInInput.style.borderColor = '#8bc34a';
                } else {
                    fillInInput.style.borderColor = '#ff7043';
                }
            }

            if (isCorrect) {
                score++;
                comboStreak++;
                scoreDisplay.textContent = score;
                feedbackText.textContent = 'ç­”å°äº†ï¼æ‰¿è’™æ‚¨ï¼';
                playSound(correctSound);
                showMascotSpeech("ä½ çœŸæ£’ï¼", 1500, 'images/mascot_happy.png');
                showComboStreak();
            } else {
                comboStreak = 0;
                feedbackText.textContent = `ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼šã€Œ${actualCorrectAnswer}ã€ã€‚`;
                playSound(wrongSound);
                showMascotSpeech("æ²’é—œä¿‚ï¼å†æƒ³æƒ³ï¼", 1500, 'images/mascot_sad.png');
                comboStreakDisplay.classList.add('hidden');
            }
            nextButton.classList.remove('hidden');
        }

        // ä¸‹ä¸€é¡Œï¼ˆå–®äººæ¨¡å¼ï¼‰
        function nextQuestion() {
            if (currentMode === 'single') {
                currentQuestionIndex++;
                loadQuestionSinglePlayer();
            } else {
                // å¤šäººæ¨¡å¼ä¸‹ 'ä¸‹ä¸€é¡Œ' æŒ‰éˆ•è¡Œç‚ºç”±æˆ¿ä¸»è§¸ç™¼ï¼Œä¸¦é€é Firebase ç›£è½æ›´æ–°
                console.log("å¤šäººæ¨¡å¼ä¸‹ï¼Œä¸‹ä¸€é¡Œé‚è¼¯ç”±æˆ¿é–“ç‹€æ…‹æ›´æ–°è§¸ç™¼ã€‚");
            }
        }

        // --- æ’è¡Œæ¦œç›¸é—œåŠŸèƒ½ ---
        async function submitScore() {
            const playerName = prompt('è«‹è¼¸å…¥æ‚¨çš„å§“å (å°‡ç”¨æ–¼æ’è¡Œæ¦œ):', localStorage.getItem('playerName') || 'åŒ¿åç©å®¶');
            if (playerName) {
                localStorage.setItem('playerName', playerName);
                try {
                    await db.collection('leaderboard').add({
                        name: playerName,
                        score: score,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('åˆ†æ•¸å·²æäº¤æˆåŠŸï¼');
                    showLeaderboard();
                } catch (e) {
                    console.error("æäº¤åˆ†æ•¸å¤±æ•—: ", e);
                    alert('æäº¤åˆ†æ•¸å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            }
        }

        async function showLeaderboard() {
            // --- ä¿®æ­£é» 2: ç¢ºä¿æ‰€æœ‰éæ’è¡Œæ¦œå®¹å™¨éƒ½è¢«éš±è— ---
            gameContainer.classList.add('hidden');
            levelSelectionContainer.classList.add('hidden');
            multiplayerLobby.classList.add('hidden');
            gameRoomContainer.classList.add('hidden');
            leaderboardContainer.classList.remove('hidden'); // é¡¯ç¤ºæ’è¡Œæ¦œ

            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;

            leaderboardList.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';
            try {
                const snapshot = await db.collection('leaderboard').orderBy('score', 'desc').limit(10).get();
                leaderboardList.innerHTML = '';
                if (snapshot.empty) {
                    leaderboardList.innerHTML = '<li>ç›®å‰é‚„æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</li>';
                    return;
                }
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>${index + 1}. ${data.name}</span><span>${data.score} åˆ†</span>`;
                    leaderboardList.appendChild(listItem);
                });
                showMascotSpeech("çœ‹çœ‹èª°æ˜¯å®¢èªå¤§å¸«ï¼", 2000, 'images/mascot_smile.png');

            }
            catch (e) {
                console.error("è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—: ", e);
                leaderboardList.innerHTML = '<li>è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—ã€‚</li>';
            }
        }

        // --- ä¿®æ­£é» 3: å°‡è¿”å›æ’è¡Œæ¦œçš„é‚è¼¯çµ±ä¸€å‘¼å« showModeSelection() ---
        function returnFromLeaderboard() {
            showModeSelection();
        }

        // --- æ¨¡å¼é¸æ“‡èˆ‡éŠæˆ²é–‹å§‹å‡½æ•¸ ---

        // é¡¯ç¤ºæ¨¡å¼é¸æ“‡ä»‹é¢
        function showModeSelection() {
            console.log("é€²å…¥ showModeSelection..."); // é™¤éŒ¯è¨Šæ¯

            clearInterval(timerInterval); // åœæ­¢ä»»ä½•å¯èƒ½æ­£åœ¨é‹è¡Œçš„è¨ˆæ™‚å™¨

            // --- ä¿®æ­£é» 4: ç¢ºä¿ Firebase ç›£è½å™¨è¢«å–æ¶ˆ (ç‰¹åˆ¥æ˜¯å¤šäººæ¨¡å¼) ---
            if (roomSnapshotListener) {
                console.log("å–æ¶ˆ Firebase æˆ¿é–“ç›£è½å™¨.");
                roomSnapshotListener(); // å–æ¶ˆèˆŠçš„ç›£è½
                roomSnapshotListener = null;
            }

            // --- ä¿®æ­£é» 5: ç¢ºä¿æ‰€æœ‰å®¹å™¨çš„é¡¯ç¤º/éš±è—ç‹€æ…‹æ­£ç¢ºè¨­å®š ---
            levelSelectionContainer.classList.remove('hidden'); // é¡¯ç¤ºé¦–é  (æ¨¡å¼é¸æ“‡)

            gameContainer.classList.add('hidden');
            leaderboardContainer.classList.add('hidden');
            multiplayerLobby.classList.add('hidden');
            gameRoomContainer.classList.add('hidden');

            // éš±è—æ‰€æœ‰éŠæˆ²çµæŸ/éŠæˆ²ä¸­å¯èƒ½å‡ºç¾çš„æŒ‰éˆ•
            nextButton.classList.add('hidden');
            submitScoreButton.classList.add('hidden');
            restartButton.classList.add('hidden');
            showLeaderboardGameEndButton.classList.add('hidden');
            if (returnToModeSelectionFromGameButton) { // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå› ç‚ºå®ƒå¯èƒ½åªåœ¨éŠæˆ²çµæŸå¾Œæ‰å­˜åœ¨
                returnToModeSelectionFromGameButton.classList.add('hidden');
            }


            // é‡ç½®éŠæˆ²ä»‹é¢ä¸­çš„è¨ˆåˆ†æ¿ã€è¨ˆæ™‚å™¨ç­‰å…ƒç´ 
            score = 0; // é‡ç½®åˆ†æ•¸
            currentQuestionIndex = 0; // é‡ç½®é¡Œç›®ç´¢å¼•
            comboStreak = 0; // é‡ç½®é€£æ“Šæ•¸
            scoreDisplay.textContent = '0';
            totalQuestionsDisplay.textContent = NUM_QUESTIONS_PER_GAME; // é‡ç½®ç¸½é¡Œæ•¸é¡¯ç¤º
            timerDisplay.textContent = TIME_PER_QUESTION; // é‡ç½®è¨ˆæ™‚å™¨é¡¯ç¤º
            timerArea.classList.add('hidden'); // éš±è—è¨ˆæ™‚å™¨
            timerArea.classList.remove('time-low'); // ç§»é™¤è¨ˆæ™‚å™¨è­¦å‘Šæ¨£å¼
            questionText.textContent = ''; // æ¸…ç©ºé¡Œç›®é¡¯ç¤º
            optionsContainer.innerHTML = ''; // æ¸…ç©ºé¸é …
            fillInContainer.classList.add('hidden'); // éš±è—å¡«ç©º
            fillInInput.value = ''; // æ¸…ç©ºå¡«ç©ºè¼¸å…¥æ¡†
            feedbackText.textContent = ''; // æ¸…ç©ºå›é¥‹æ–‡å­—
            questionImage.classList.add('hidden'); // éš±è—åœ–ç‰‡é¡Œç›®
            questionImage.src = '';

            comboStreakDisplay.classList.add('hidden'); // éš±è—é€£æ“Šæç¤º

            backgroundMusic.pause();
            backgroundMusic.currentTime = 0; // é‡ç½®éŸ³æ¨‚åˆ°é–‹é ­

            showMascotSpeech("æ­¡è¿å›ä¾†ï¼é¸æ“‡ä½ æƒ³ç©çš„æ¨¡å¼å§ï¼", 2000, 'images/mascot_neutral.png');

            // --- ä¿®æ­£é» 6: å‹•æ…‹ä¿®æ”¹ levelSelectionContainer çš„å…§å®¹æ™‚ï¼Œç¢ºä¿è¿”å›æŒ‰éˆ•äº‹ä»¶é‡æ–°ç¶å®š ---
            // å› ç‚º showLevelSelectionForSinglePlayer æœƒæ”¹è®Š levelSelectionContainer çš„å…§å®¹ï¼Œ
            // é€™è£¡éœ€è¦ç¢ºä¿é¦–é çš„æŒ‰éˆ•äº‹ä»¶æ˜¯ç¶å®šåœ¨æœ€åŸå§‹çš„ HTML çµæ§‹ä¸Š
            // æˆ–è€…ï¼Œå¦‚æœæ¯æ¬¡éƒ½å‹•æ…‹ç”Ÿæˆé¦–é å…§å®¹ï¼Œå°±éœ€è¦åœ¨é€™è£¡é‡æ–°ç¶å®š mode-button å’Œ show-leaderboard-initial
            // ç‚ºäº†ç°¡åŒ–ï¼Œè®“ showLevelSelectionForSinglePlayer å°ˆé–€è™•ç†å®ƒçš„ä»‹é¢ï¼Œ
            // showModeSelection è² è²¬å›åˆ°æœ€åˆå§‹çš„é¦–é ç‹€æ…‹ã€‚
            // å› æ­¤ï¼Œé€™è£¡ä¸æ‡‰è©²æœ‰ `levelSelectionContainer.innerHTML = ...` çš„æ“ä½œï¼Œ
            // è€Œæ˜¯è®“ HTML é è¨­çµæ§‹å°±æ˜¯é¦–é ï¼Œç„¶å¾Œå‹•æ…‹åˆ‡æ›åˆ°é›£åº¦é¸æ“‡é æ™‚å†ä¿®æ”¹å…§å®¹ã€‚
            // (é€™åœ¨æ‚¨åŸä¾†çš„ HTML çµæ§‹ä¸­æ˜¯é€™æ¨£è™•ç†çš„ï¼Œå³ `levelSelectionContainer` æ˜¯é¦–é çš„æ ¹å®¹å™¨)
            // æ‰€ä»¥é€™è£¡ä¸éœ€è¦é¡å¤–æ“ä½œ `levelSelectionContainer.innerHTML`
        }

        // é¡¯ç¤ºé›£åº¦é¸æ“‡ä»‹é¢ (å–®äººæ¨¡å¼)
        function showLevelSelectionForSinglePlayer() {
            levelSelectionContainer.classList.remove('hidden'); // ç¢ºä¿é›£åº¦é¸æ“‡å®¹å™¨æ˜¯å¯è¦‹çš„
            gameContainer.classList.add('hidden');
            multiplayerLobby.classList.add('hidden');
            gameRoomContainer.classList.add('hidden');
            leaderboardContainer.classList.add('hidden');

            // å‹•æ…‹ä¿®æ”¹ levelSelectionContainer çš„å…§å®¹ç‚ºé›£åº¦é¸æ“‡æŒ‰éˆ•
            levelSelectionContainer.innerHTML = `
                <h1>å®¢èªèªè­‰è€ƒé¡Œå°å°ç¢°</h1>
                <h2>è«‹é¸æ“‡æŒ‘æˆ°é›£åº¦ï¼š</h2>
                <button class="level-button" data-level="easy">åˆç´š</button>
                <button class="level-button" data-level="medium">ä¸­ç´š</button>
                <button class="level-button" data-level="hard">é«˜ç´š</button>
                <button id="returnToModeSelectionFromLevels" class="btn return-btn">è¿”å›æ¨¡å¼é¸æ“‡</button>
            `;
            // --- ä¿®æ­£é» 7: å‹•æ…‹ç”ŸæˆæŒ‰éˆ•å¾Œï¼Œå¿…é ˆé‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨ ---
            document.querySelectorAll('.level-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const level = event.target.dataset.level;
                    startGame(level); // å‘¼å«å–®äººæ¨¡å¼é–‹å§‹éŠæˆ²
                });
            });
            // ç¶å®šã€Œå¾é›£åº¦é¸æ“‡è¿”å›æ¨¡å¼é¸æ“‡ã€çš„æŒ‰éˆ•
            const returnToModeSelectionFromLevelsBtn = document.getElementById('returnToModeSelectionFromLevels');
            if (returnToModeSelectionFromLevelsBtn) {
                returnToModeSelectionFromLevelsBtn.addEventListener('click', showModeSelection);
            }
            showMascotSpeech("æº–å‚™å¥½äº†å—ï¼ŸæŒ‘å€‹é›£åº¦é–‹å§‹å§ï¼", 2000, 'images/mascot_smile.png');
        }

        // å–®äººæ¨¡å¼é–‹å§‹éŠæˆ²
        function startGame(level) {
            currentMode = 'single'; // è¨­å®šç‚ºå–®äººæ¨¡å¼
            selectedLevel = level;
            score = 0;
            currentQuestionIndex = 0;
            currentQuestions = getRandomQuestions(NUM_QUESTIONS_PER_GAME, selectedLevel);
            totalQuestionsDisplay.textContent = currentQuestions.length;
            scoreDisplay.textContent = score;

            levelSelectionContainer.classList.add('hidden'); // éš±è—é›£åº¦é¸æ“‡
            gameContainer.classList.remove('hidden'); // é¡¯ç¤ºéŠæˆ²ä»‹é¢
            leaderboardContainer.classList.add('hidden');
            multiplayerLobby.classList.add('hidden');
            gameRoomContainer.classList.add('hidden');

            nextButton.classList.add('hidden');
            submitScoreButton.classList.add('hidden');
            restartButton.classList.add('hidden');
            showLeaderboardGameEndButton.classList.add('hidden');
            returnToModeSelectionFromGameButton.classList.remove('hidden'); // éŠæˆ²ä¸­é¡¯ç¤ºè¿”å›æŒ‰éˆ•
            timerArea.classList.remove('hidden');
            timerArea.classList.remove('time-low');

            loadQuestionSinglePlayer();
        }


        // å¤šäººå°æˆ°ç›¸é—œé‚è¼¯
        function generatePlayerId() {
            return 'player_' + Date.now() + Math.random().toString(36).substring(2, 9);
        }

        // é¡¯ç¤ºå¤šäººå°æˆ°å¤§å»³
        async function showMultiplayerLobby() {
            currentMode = 'multi';
            clearInterval(timerInterval);
            // --- ä¿®æ­£é» 8: ç¢ºä¿ Firebase ç›£è½å™¨åœ¨é€²å…¥å¤§å»³æ™‚è¢«æ¸…ç† ---
            if (roomSnapshotListener) {
                roomSnapshotListener();
                roomSnapshotListener = null;
            }

            levelSelectionContainer.classList.add('hidden');
            gameContainer.classList.add('hidden');
            leaderboardContainer.classList.add('hidden');
            multiplayerLobby.classList.remove('hidden'); // é¡¯ç¤ºå¤§å»³
            gameRoomContainer.classList.add('hidden');

            myPlayerId = generatePlayerId();
            playerNameInput.value = localStorage.getItem('playerName') || 'ç©å®¶' + Math.floor(Math.random() * 1000);
            myPlayerName = playerNameInput.value;
            localStorage.setItem('playerName', myPlayerName);

            showMascotSpeech("æ­¡è¿ä¾†åˆ°å°æˆ°å¤§å»³ï¼", 2000, 'images/mascot_neutral.png');
            await updateAvailableRooms();
        }

        // æ›´æ–°å¯ç”¨æˆ¿é–“åˆ—è¡¨
        async function updateAvailableRooms() {
            availableRoomsList.innerHTML = '<li style="text-align: center; color: #888;">è¼‰å…¥æˆ¿é–“ä¸­...</li>';
            try {
                const snapshot = await db.collection('rooms').where('status', '==', 'waiting').get();
                availableRoomsList.innerHTML = '';
                if (snapshot.empty) {
                    availableRoomsList.innerHTML = '<li style="text-align: center; color: #888;">ç›®å‰æ²’æœ‰é–‹æ”¾ä¸­çš„æˆ¿é–“ï¼Œå¿«ä¾†å‰µå»ºä¸€å€‹å§ï¼</li>';
                    return;
                }
                snapshot.forEach(doc => {
                    const room = doc.data();
                    const hostName = room.players[room.hostId]?.name || 'æœªçŸ¥ç©å®¶';
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>æˆ¿é–“ ID: ${doc.id.substring(0, 6)} - ä¸»æ©Ÿ: ${hostName} (${Object.keys(room.players).length}/2)</span>
                        <button data-room-id="${doc.id}">åŠ å…¥</button>
                    `;
                    listItem.querySelector('button').addEventListener('click', () => joinRoom(doc.id));
                    availableRoomsList.appendChild(listItem);
                });
            } catch (error) {
                console.error("æ›´æ–°æˆ¿é–“åˆ—è¡¨å¤±æ•—:", error);
                alert("æ›´æ–°æˆ¿é–“åˆ—è¡¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        // å‰µå»ºæˆ¿é–“
        async function createRoom() {
            myPlayerName = playerNameInput.value.trim() || 'ç©å®¶';
            if (myPlayerName.length < 2) {
                alert("è«‹è¼¸å…¥è‡³å°‘å…©å€‹å­—å…ƒçš„ç©å®¶åç¨±ã€‚");
                return;
            }
            localStorage.setItem('playerName', myPlayerName);

            try {
                const newRoomRef = await db.collection('rooms').add({
                    status: 'waiting',
                    hostId: myPlayerId,
                    players: {
                        [myPlayerId]: {
                            name: myPlayerName,
                            score: 0,
                            ready: false,
                            lastAnswerTime: null, // æ–°å¢ç”¨æ–¼å¤šäººæ¨¡å¼åˆ¤æ–·ç­”é¡Œæ™‚é–“
                            submittedAnswer: null // æ–°å¢ç”¨æ–¼å¤šäººæ¨¡å¼å„²å­˜ç­”æ¡ˆ
                        }
                    },
                    currentQuestion: null,
                    questionIndex: 0,
                    roundEndTime: null,
                    winnerId: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                currentRoomId = newRoomRef.id;
                await enterGameRoom(currentRoomId);
                showMascotSpeech(`æˆ¿é–“å‰µå»ºæˆåŠŸï¼ç­‰å¾…å°æ‰‹åŠ å…¥ã€‚`, 2500, 'images/mascot_smile.png');
                alert(`æˆ¿é–“å‰µå»ºæˆåŠŸï¼æˆ¿é–“ ID: ${currentRoomId.substring(0, 6)}`);
            } catch (error) {
                console.error("å‰µå»ºæˆ¿é–“å¤±æ•—:", error);
                alert("å‰µå»ºæˆ¿é–“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        // åŠ å…¥æˆ¿é–“
        async function joinRoom(roomId = null) {
            if (!roomId) {
                roomId = prompt('è«‹è¼¸å…¥æˆ¿é–“ ID (å‰6ä½å­—å…ƒå³å¯):');
                if (!roomId) return;
                const shortId = roomId.toLowerCase();
                try {
                    const snapshot = await db.collection('rooms').get();
                    let fullRoomId = null;
                    snapshot.forEach(doc => {
                        if (doc.id.toLowerCase().startsWith(shortId)) {
                            fullRoomId = doc.id;
                        }
                    });
                    if (fullRoomId) {
                        roomId = fullRoomId;
                    } else {
                        alert('æˆ¿é–“ä¸å­˜åœ¨æˆ–è¼¸å…¥éŒ¯èª¤ã€‚');
                        return;
                    }
                } catch (error) {
                    console.error("æœå°‹æˆ¿é–“å¤±æ•—:", error);
                    alert("æœå°‹æˆ¿é–“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    return;
                }
            }
            myPlayerName = playerNameInput.value.trim() || 'ç©å®¶';
            if (myPlayerName.length < 2) {
                alert("è«‹è¼¸å…¥è‡³å°‘å…©å€‹å­—å…ƒçš„ç©å®¶åç¨±ã€‚");
                return;
            }
            localStorage.setItem('playerName', myPlayerName);

            try {
                const roomRef = db.collection('rooms').doc(roomId);
                const roomDoc = await roomRef.get();

                if (!roomDoc.exists) {
                    alert('æˆ¿é–“ä¸å­˜åœ¨æˆ–å·²çµæŸã€‚');
                    return;
                }

                const roomData = roomDoc.data();
                if (roomData.status !== 'waiting') {
                    alert('è©²æˆ¿é–“å·²é–‹å§‹éŠæˆ²æˆ–å·²çµæŸã€‚');
                    return;
                }

                if (Object.keys(roomData.players).length >= 2) {
                    alert('è©²æˆ¿é–“å·²æ»¿ã€‚');
                    return;
                }

                await roomRef.update({
                    [`players.${myPlayerId}`]: {
                        name: myPlayerName,
                        score: 0,
                        ready: false,
                        lastAnswerTime: null,
                        submittedAnswer: null
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                currentRoomId = roomId;
                await enterGameRoom(currentRoomId);
                showMascotSpeech(`æˆåŠŸåŠ å…¥æˆ¿é–“ï¼`, 2000, 'images/mascot_smile.png');
            } catch (error) {
                console.error("åŠ å…¥æˆ¿é–“å¤±æ•—:", error);
                alert("åŠ å…¥æˆ¿é–“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        // é€²å…¥éŠæˆ²æˆ¿é–“ä»‹é¢ä¸¦ç›£è½ç‹€æ…‹
        async function enterGameRoom(roomId) {
            multiplayerLobby.classList.add('hidden');
            gameContainer.classList.add('hidden');
            gameRoomContainer.classList.remove('hidden'); // é¡¯ç¤ºéŠæˆ²æˆ¿é–“

            currentRoomIdDisplay.textContent = roomId.substring(0, 6);
            myPlayerNameDisplay.textContent = myPlayerName;
            myPlayerScoreDisplay.textContent = 0;
            opponentPlayerScoreDisplay.textContent = 0;

            // --- ä¿®æ­£é» 9: é€²å…¥æ–°æˆ¿é–“å‰ï¼Œå–æ¶ˆä»»ä½•èˆŠçš„ç›£è½å™¨ ---
            if (roomSnapshotListener) {
                roomSnapshotListener(); // å–æ¶ˆèˆŠçš„ç›£è½
            }
            roomSnapshotListener = db.collection('rooms').doc(roomId).onSnapshot(docSnapshot => {
                if (!docSnapshot.exists) {
                    alert('æˆ¿é–“å·²è§£æ•£ã€‚');
                    showMultiplayerLobby(); // è¿”å›å¤§å»³
                    return;
                }

                const room = docSnapshot.data();
                const players = room.players || {};
                let opponentId = null;
                for (const id in players) {
                    if (id !== myPlayerId) {
                        opponentId = id;
                        break;
                    }
                }
                opponentPlayerId = opponentId;

                if (opponentId) {
                    opponentPlayerNameDisplay.textContent = players[opponentId]?.name || 'å°æ‰‹';
                    opponentPlayerScoreDisplay.textContent = players[opponentId]?.score || 0;
                } else {
                    opponentPlayerNameDisplay.textContent = 'ç­‰å¾…ä¸­...';
                    opponentPlayerScoreDisplay.textContent = 0;
                }
                myPlayerScoreDisplay.textContent = players[myPlayerId]?.score || 0;


                if (room.status === 'waiting') {
                    roomStatusMessage.textContent = `ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥... (æˆ¿é–“äººæ•¸: ${Object.keys(players).length}/2)`;
                    startGameInRoomBtn.classList.add('hidden');
                    if (room.hostId === myPlayerId && Object.keys(players).length === 2) {
                        startGameInRoomBtn.classList.remove('hidden');
                    }
                    leaveRoomBtn.classList.remove('hidden');
                    optionsContainer.classList.add('hidden');
                    fillInContainer.classList.add('hidden');
                    questionText.textContent = '';
                    feedbackText.textContent = '';
                    timerArea.classList.add('hidden');

                } else if (room.status === 'playing') {
                    gameRoomContainer.classList.add('hidden'); // éŠæˆ²é–‹å§‹ï¼Œéš±è—æˆ¿é–“ä»‹é¢
                    gameContainer.classList.remove('hidden'); // é¡¯ç¤ºéŠæˆ²é€²è¡Œä»‹é¢
                    startGameInRoomBtn.classList.add('hidden');
                    leaveRoomBtn.classList.remove('hidden');
                    returnToModeSelectionFromGameButton.classList.add('hidden'); // éŠæˆ²ä¸­ä¸é¡¯ç¤ºé€™å€‹æŒ‰éˆ•
                    timerArea.classList.remove('hidden');

                    const currentQData = room.currentQuestion; // å–å¾—ç•¶å‰é¡Œç›®æ•¸æ“š
                    const roundEndTime = room.roundEndTime?.toDate();
                    const now = new Date();
                    timeLeft = Math.max(0, Math.floor((roundEndTime - now) / 1000));

                    // å¦‚æœé¡Œç›®æ›´æ–°äº†ï¼Œæ‰é‡æ–°è¼‰å…¥é¡Œç›®
                    if (currentQData && questionText.dataset.questionId !== currentQData.questionId) {
                        questionText.dataset.questionId = currentQData.questionId;
                        currentQuestionIndex = room.questionIndex;
                        loadQuestionMultiplayer(currentQData); // ä½¿ç”¨ currentQData è¼‰å…¥é¡Œç›®
                        showMascotSpeech("æ–°çš„å°æˆ°é¡Œç›®ä¾†äº†ï¼", 1500, 'images/mascot_neutral.png');
                        // é‡ç½® feedbackText å’ŒæŒ‰éˆ•ç‹€æ…‹
                        feedbackText.textContent = '';
                        enableControls();
                    } else if (!currentQData) {
                        questionText.textContent = 'ç­‰å¾…éŠæˆ²é–‹å§‹...'; // å‰›é€²å…¥ playing ç‹€æ…‹ï¼Œä½†é¡Œç›®é‚„æ²’åŒæ­¥
                    }
                    updateTimerDisplayMultiplayer();

                    // å¦‚æœæœ¬åœ°ç©å®¶å·²ç¶“æäº¤äº†ç­”æ¡ˆï¼Œå‰‡ç¦ç”¨æ§åˆ¶é …ä¸¦é¡¯ç¤ºç­‰å¾…è³‡è¨Š
                    if (players[myPlayerId]?.submittedAnswer !== null) {
                        disableControls();
                        feedbackText.textContent = "æ‚¨å·²æäº¤ç­”æ¡ˆï¼Œç­‰å¾…å…¶ä»–ç©å®¶...";
                    }

                } else if (room.status === 'ended') {
                    clearInterval(timerInterval);
                    gameRoomContainer.classList.add('hidden');
                    gameContainer.classList.remove('hidden'); // é¡¯ç¤ºéŠæˆ²çµæŸä»‹é¢
                    timerArea.classList.add('hidden');
                    backgroundMusic.pause();
                    backgroundMusic.currentTime = 0;

                    const finalScores = room.players;
                    let finalMessage = 'éŠæˆ²çµæŸï¼\n';
                    if (room.winnerId) {
                        finalMessage += `ç²å‹è€…æ˜¯ï¼š${finalScores[room.winnerId]?.name}ï¼\n`;
                        showMascotSpeech("æ­å–œç²å‹ï¼", 3000, 'images/mascot_happy.png');
                    } else {
                        finalMessage += 'éŠæˆ²å¹³æ‰‹ï¼\n';
                        showMascotSpeech("æ——é¼“ç›¸ç•¶ï¼Œå¹³æ‰‹äº†ï¼", 3000, 'images/mascot_smile.png');
                    }
                    finalMessage += 'æœ€çµ‚åˆ†æ•¸ï¼š\n';
                    for (const pId in finalScores) {
                        finalMessage += `${finalScores[pId].name}: ${finalScores[pId].score} åˆ†\n`;
                    }

                    questionText.innerHTML = finalMessage.replace(/\n/g, '<br>');
                    optionsContainer.innerHTML = '';
                    fillInContainer.classList.add('hidden');
                    feedbackText.textContent = '';
                    nextButton.classList.add('hidden');
                    startGameInRoomBtn.classList.add('hidden');
                    submitScoreButton.classList.add('hidden');
                    restartButton.classList.add('hidden');
                    showLeaderboardGameEndButton.classList.add('hidden');
                    leaveRoomBtn.classList.add('hidden');
                    returnToModeSelectionFromGameButton.classList.remove('hidden'); // éŠæˆ²çµæŸæ™‚é¡¯ç¤ºè¿”å›æŒ‰éˆ•
                    returnToModeSelectionFromGameButton.textContent = 'è¿”å›æ¨¡å¼é¸æ“‡'; // ç¢ºä¿æ–‡å­—æ­£ç¢º
                }
            }, error => {
                console.error("ç›£è½æˆ¿é–“ç‹€æ…‹å¤±æ•—:", error);
                alert("æˆ¿é–“é€£ç·šæ–·é–‹ï¼Œè«‹å˜—è©¦é‡æ–°åŠ å…¥æˆ–è¿”å›å¤§å»³ã€‚");
                showMultiplayerLobby(); // é€£ç·šå¤±æ•—ï¼Œè¿”å›å¤§å»³
            });
        }

        // é›¢é–‹æˆ¿é–“
        async function leaveRoom() {
            if (!currentRoomId) {
                showModeSelection(); // å¦‚æœæ²’æœ‰æˆ¿é–“IDï¼Œç›´æ¥è¿”å›æ¨¡å¼é¸æ“‡
                return;
            }

            clearInterval(timerInterval);
            if (roomSnapshotListener) {
                roomSnapshotListener(); // å–æ¶ˆç›£è½
            }

            try {
                const roomRef = db.collection('rooms').doc(currentRoomId);
                const roomDoc = await roomRef.get();
                if (roomDoc.exists) {
                    const roomData = roomDoc.data();
                    if (Object.keys(roomData.players).length === 1 && roomData.players[myPlayerId]) {
                        // å¦‚æœæˆ‘æ˜¯æœ€å¾Œä¸€å€‹ç©å®¶ï¼Œå‰‡åˆªé™¤æˆ¿é–“
                        await roomRef.delete();
                        console.log(`æˆ¿é–“ ${currentRoomId} å·²åˆªé™¤ã€‚`);
                    } else if (roomData.players[myPlayerId]) {
                        // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å€‹ç©å®¶ï¼Œåªç§»é™¤è‡ªå·±
                        const updates = {};
                        updates[`players.${myPlayerId}`] = firebase.firestore.FieldValue.delete();
                        // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œä¸”é‚„æœ‰å…¶ä»–ç©å®¶ï¼Œå‰‡å°‡æˆ¿ä¸»è½‰ç§»çµ¦å¦ä¸€å€‹ç©å®¶
                        if (roomData.hostId === myPlayerId && Object.keys(roomData.players).length > 1) {
                            const remainingPlayers = Object.keys(roomData.players).filter(id => id !== myPlayerId);
                            if (remainingPlayers.length > 0) {
                                updates.hostId = remainingPlayers[0];
                                updates.status = 'waiting'; // æˆ¿é–“å›åˆ°ç­‰å¾…ç‹€æ…‹
                                updates.currentQuestion = null;
                                updates.questionIndex = 0;
                                // æ¸…ç©ºæ‰€æœ‰ç©å®¶çš„ç­”é¡Œç‹€æ…‹ï¼Œæº–å‚™æ–°éŠæˆ²
                                for (const pId in roomData.players) {
                                    if (pId !== myPlayerId) { // ä¸åŒ…å«è‡ªå·±ï¼Œå› ç‚ºè‡ªå·±è¦é›¢é–‹äº†
                                        updates[`players.${pId}.submittedAnswer`] = null;
                                        updates[`players.${pId}.lastAnswerTime`] = null;
                                        updates[`players.${pId}.ready`] = false; // é‡ç½®æº–å‚™ç‹€æ…‹
                                    }
                                }
                            }
                        }
                        await roomRef.update(updates);
                        console.log(`ç©å®¶ ${myPlayerName} å·²é›¢é–‹æˆ¿é–“ ${currentRoomId}ã€‚`);
                    }
                }
            } catch (error) {
                console.error("é›¢é–‹æˆ¿é–“å¤±æ•—:", error);
                alert("é›¢é–‹æˆ¿é–“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                currentRoomId = null;
                opponentPlayerId = null;
                showMascotSpeech("å·²é›¢é–‹æˆ¿é–“ã€‚", 1500, 'images/mascot_sad.png');
                showMultiplayerLobby(); // è¿”å›å¤§å»³ï¼Œå¾å¤§å»³å†è¿”å›æ¨¡å¼é¸æ“‡
            }
        }

        // å¤šäººæ¨¡å¼ä¸‹é–‹å§‹éŠæˆ² (åƒ…é™æˆ¿ä¸»)
        async function startGameInRoom() {
            if (!currentRoomId) return;

            try {
                const roomRef = db.collection('rooms').doc(currentRoomId);
                const roomDoc = await roomRef.get();
                const roomData = roomDoc.data();

                if (roomData.hostId !== myPlayerId) {
                    alert('åªæœ‰æˆ¿ä¸»æ‰èƒ½é–‹å§‹éŠæˆ²ï¼');
                    return;
                }
                if (Object.keys(roomData.players).length < 2) {
                    alert('è‡³å°‘éœ€è¦å…©ä½ç©å®¶æ‰èƒ½é–‹å§‹éŠæˆ²ï¼');
                    return;
                }

                // éš¨æ©Ÿé¸å–ä¸­ç´šé¡Œç›®ï¼Œä¸¦ç‚ºæ¯å€‹é¡Œç›®ç”Ÿæˆä¸€å€‹å”¯ä¸€çš„ ID
                const questionsForGame = getRandomQuestions(NUM_QUESTIONS_PER_GAME, 'medium');
                const questionsWithIds = questionsForGame.map((q, idx) => ({ ...q, questionId: `q_${idx}_${Date.now()}` }));

                const gameQuestionsMap = {};
                questionsWithIds.forEach((q, index) => {
                    gameQuestionsMap[q.questionId] = { // ä½¿ç”¨ questionId ä½œç‚ºéµ
                        question: q.question,
                        options: q.options || [],
                        type: q.type,
                        image: q.image || null,
                        correctAnswer: q.answer
                    };
                });

                const firstQuestion = questionsWithIds[0];
                const now = new Date();
                await roomRef.update({
                    status: 'playing',
                    questions: gameQuestionsMap,
                    currentQuestion: {
                        questionId: firstQuestion.questionId,
                        question: firstQuestion.question,
                        options: firstQuestion.options || [],
                        type: firstQuestion.type,
                        image: firstQuestion.image || null,
                    },
                    questionIndex: 0,
                    roundEndTime: firebase.firestore.Timestamp.fromMillis(now.getTime() + TIME_PER_QUESTION * 1000),
                    winnerId: null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // é‡ç½®æ‰€æœ‰ç©å®¶çš„ç­”é¡Œç‹€æ…‹ï¼Œæº–å‚™æ–°éŠæˆ²
                    'players': Object.keys(roomData.players).reduce((acc, playerId) => {
                        acc[playerId] = { ...roomData.players[playerId], score: 0, submittedAnswer: null, lastAnswerTime: null, ready: false };
                        return acc;
                    }, {})
                });

                gameRoomContainer.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                timerArea.classList.remove('hidden');
                backgroundMusic.play().catch(e => console.log("èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å¤±æ•—:", e));
                showMascotSpeech("éŠæˆ²é–‹å§‹ï¼ç¥æ‚¨å¥½é‹ï¼", 2000, 'images/mascot_happy.png');


            } catch (error) {
                console.error("å•Ÿå‹•å¤šäººéŠæˆ²å¤±æ•—:", error);
                alert("å•Ÿå‹•éŠæˆ²å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }


        // å¤šäººæ¨¡å¼ä¸‹çš„è¼‰å…¥é¡Œç›®
        function loadQuestionMultiplayer(q) {
            optionsContainer.innerHTML = '';
            fillInContainer.classList.add('hidden');
            fillInInput.value = '';
            feedbackText.textContent = '';
            questionImage.classList.add('hidden'); // éš±è—åœ–ç‰‡
            questionImage.src = ''; // æ¸…ç©ºåœ–ç‰‡æº
            timerArea.classList.remove('hidden');
            timerArea.classList.remove('time-low');

            questionText.textContent = q.question;

            if (q.image) { // å¦‚æœæ˜¯åœ–ç‰‡é¡Œ
                questionImage.src = q.image;
                questionImage.classList.remove('hidden');
            }

            if (q.type === 'multiple-choice' || q.type === 'image-choice') {
                optionsContainer.classList.remove('hidden');
                optionsContainer.style.display = 'grid';
                q.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.classList.add('option-button');
                    button.textContent = option;
                    button.dataset.index = index;
                    button.addEventListener('click', () => submitAnswerMultiplayer(index, q.type));
                    optionsContainer.appendChild(button);
                });
            } else if (q.type === 'fill-in-the-blank' || q.type === 'description-fill-in') {
                optionsContainer.classList.add('hidden');
                fillInContainer.classList.remove('hidden');
                fillInInput.focus();
                fillInInput.onkeydown = (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        submitAnswerMultiplayer(fillInInput.value.trim(), q.type);
                    }
                };
                fillInSubmitButton.onclick = () => submitAnswerMultiplayer(fillInInput.value.trim(), q.type);
            }

            enableControls();
            comboStreakDisplay.classList.add('hidden');
        }

        // æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º (å¤šäººæ¨¡å¼) - æœƒç”± Firebase ç›£è½è§¸ç™¼
        function updateTimerDisplayMultiplayer() {
            // é€™å€‹å‡½æ•¸è¢« firestore onSnapshot èª¿ç”¨æ™‚ï¼ŒtimeLeft å·²ç¶“æ ¹æ“š room.roundEndTime è¨­ç½®
            timerDisplay.textContent = timeLeft;
            if (timeLeft <= WARNING_TIME) {
                timerArea.classList.add('time-low');
            } else {
                timerArea.classList.remove('time-low');
            }
        }


        // å¤šäººæ¨¡å¼ä¸‹æäº¤ç­”æ¡ˆ
        async function submitAnswerMultiplayer(answer, questionType) {
            if (!currentRoomId || !myPlayerId) return;

            clearInterval(timerInterval); // æäº¤ç­”æ¡ˆå¾Œç«‹å³åœæ­¢æœ¬åœ°è¨ˆæ™‚å™¨
            disableControls();

            try {
                const roomRef = db.collection('rooms').doc(currentRoomId);
                const roomDoc = await roomRef.get();
                const roomData = roomDoc.data();

                if (!roomData || roomData.status !== 'playing' || roomData.questionIndex !== currentQuestionIndex) {
                    console.warn("ä¸æ˜¯ç•¶å‰é¡Œç›®æˆ–éŠæˆ²ç‹€æ…‹ä¸å°ï¼Œä¸æäº¤ç­”æ¡ˆã€‚");
                    feedbackText.textContent = "é¡Œç›®å·²æ›´æ–°æˆ–éŠæˆ²ç‹€æ…‹ä¸æ­£ç¢ºã€‚";
                    return;
                }

                if (roomData.players[myPlayerId]?.submittedAnswer !== null) {
                    feedbackText.textContent = "æ‚¨å·²æäº¤éæ­¤é¡Œç­”æ¡ˆã€‚";
                    return;
                }

                // ç²å–æ­£ç¢ºç­”æ¡ˆä»¥é€²è¡Œæœ¬åœ°å›é¥‹ï¼ˆå¯¦éš›åˆ¤æ–·å»ºè­°åœ¨ Cloud Functionï¼‰
                const currentQuestionId = roomData.currentQuestion.questionId;
                const currentQuestionDetails = roomData.questions[currentQuestionId];
                let isCorrectLocal = false;
                let actualCorrectAnswer = '';

                if (currentQuestionDetails) {
                    actualCorrectAnswer = currentQuestionDetails.correctAnswer;
                    if (questionType === 'multiple-choice' || questionType === 'image-choice') {
                        isCorrectLocal = (answer === currentQuestionDetails.correctAnswer);
                    } else if (questionType === 'fill-in-the-blank' || questionType === 'description-fill-in') {
                        const normalizedSubmitted = String(answer).toLowerCase().replace(/[^\u4e00-\u9fa5a-z0-9]/g, '');
                        const normalizedCorrect = String(currentQuestionDetails.correctAnswer).toLowerCase().replace(/[^\u4e00-\u9fa5a-z0-9]/g, '');
                        isCorrectLocal = (normalizedSubmitted === normalizedCorrect);
                    }
                }

                await roomRef.update({
                    [`players.${myPlayerId}.lastAnswerTime`]: firebase.firestore.FieldValue.serverTimestamp(),
                    [`players.${myPlayerId}.submittedAnswer`]: answer,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (isCorrectLocal) {
                    // æœ¬åœ°å›é¥‹ï¼ˆåˆ†æ•¸å¢åŠ å°‡ç”± Cloud Function è™•ç†ï¼‰
                    feedbackText.textContent = "ç­”å°äº†ï¼ç­”æ¡ˆå·²æäº¤ï¼Œç­‰å¾…å°æ‰‹...";
                    playSound(correctSound);
                    showMascotSpeech("å¥½æ£’ï¼", 1500, 'images/mascot_happy.png');
                } else {
                    feedbackText.textContent = `ç­”éŒ¯äº†ã€‚ç­”æ¡ˆå·²æäº¤ï¼Œç­‰å¾…å°æ‰‹... (æ­£ç¢ºç­”æ¡ˆ: ${actualCorrectAnswer})`;
                    playSound(wrongSound);
                    showMascotSpeech("å—¯...å†æƒ³æƒ³ã€‚", 1500, 'images/mascot_sad.png');
                }
                comboStreakDisplay.classList.add('hidden');

                // **é‡è¦æç¤ºï¼š**
                // çœŸæ­£çš„åˆ†æ•¸æ›´æ–°å’ŒéŠæˆ²æµç¨‹æ¨é€²ï¼ˆå¦‚ä¸‹ä¸€é¡Œã€éŠæˆ²çµæŸåˆ¤æ–·ï¼‰ï¼Œ
                // æ‡‰é€é **Firebase Cloud Functions** ä¾†è™•ç†ã€‚
                // é€™è£¡çš„é‚è¼¯åªç”¨æ–¼å‰ç«¯çš„å³æ™‚å›é¥‹å’Œç­‰å¾…ç‹€æ…‹ã€‚
                // Cloud Function æœƒç›£è½ room document çš„æ›´æ–°ï¼Œç•¶æ‰€æœ‰ç©å®¶éƒ½æäº¤ç­”æ¡ˆï¼Œæˆ–æ™‚é–“åˆ°æ™‚ï¼Œ
                // å†ç”± Cloud Function è² è²¬æ›´æ–°ç©å®¶åˆ†æ•¸ï¼Œæ¸…ç©º lastAnswerTime/submittedAnswerï¼Œ
                // ä¸¦æ¨é€² currentQuestionIndex å’Œ roundEndTimeï¼Œæˆ–å°‡ status æ”¹ç‚º 'ended'ã€‚

            } catch (error) {
                console.error("æäº¤ç­”æ¡ˆå¤±æ•—:", error);
                feedbackText.textContent = "ç­”æ¡ˆæäº¤å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚";
            }
        }


        // --- äº‹ä»¶ç›£è½ ---
        showLeaderboardInitialButton.addEventListener('click', showLeaderboard);
        showLeaderboardGameEndButton.addEventListener('click', showLeaderboard);
        returnFromLeaderboardButton.addEventListener('click', returnFromLeaderboard);
        nextButton.addEventListener('click', nextQuestion);
        submitScoreButton.addEventListener('click', submitScore);
        // --- ä¿®æ­£é» 10: ç¢ºä¿é‡æ–°é–‹å§‹æŒ‰éˆ•è¿”å›æ¨¡å¼é¸æ“‡ï¼Œè€Œéç›´æ¥é‡æ–°éŠæˆ² ---
        restartButton.addEventListener('click', () => {
            showModeSelection(); // è¿”å›é¦–é 
        });

        // ç›£è½æ¨¡å¼é¸æ“‡æŒ‰éˆ• (åœ¨é¦–é )
        levelSelectionContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('mode-button')) {
                const mode = event.target.dataset.mode;
                currentMode = mode;
                if (mode === 'single') {
                    showLevelSelectionForSinglePlayer();
                } else { // 'multi'
                    showMultiplayerLobby();
                }
            } else if (event.target.id === 'show-leaderboard-initial') {
                showLeaderboard();
            }
        });

        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', () => joinRoom());
        refreshRoomsBtn.addEventListener('click', updateAvailableRooms);
        startGameInRoomBtn.addEventListener('click', startGameInRoom);
        leaveRoomBtn.addEventListener('click', leaveRoom);
        // --- ä¿®æ­£é» 11: çµ±ä¸€è¿”å›æ¨¡å¼é¸æ“‡çš„æŒ‰éˆ•äº‹ä»¶ ---
        returnToModeSelectionFromLobbyBtn.addEventListener('click', showModeSelection);
        if (returnToModeSelectionFromGameButton) { // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨å†ç¶å®š
            returnToModeSelectionFromGameButton.addEventListener('click', () => {
                showModeSelection();
            });
        }


        // åˆå§‹ç‹€æ…‹ï¼šé¡¯ç¤ºæ¨¡å¼é¸æ“‡ä»‹é¢
        showModeSelection();
    </script>
</body>
</html>