<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客語認證考題對對碰 - 精緻版</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Compatibility versions for global access) -->
    <!-- 使用相容性版本以支援 firebase.initializeApp() 和 firebase.firestore() 語法 -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* 全局字體設定，確保所有文字使用 Noto Sans TC */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #a8dadc, #457b9d); /* 清新藍綠漸變背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            position: relative;
            animation: backgroundFadeIn 1.5s ease-out forwards; /* 背景載入動畫 */
        }

        @keyframes backgroundFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* 背景裝飾元素，增加畫面層次感，營造活潑氛圍 */
        body::before, body::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25); /* 更明顯的半透明白色 */
            filter: blur(80px); /* 更柔和的模糊 */
            z-index: 0;
            animation: floatBubble 12s infinite ease-in-out alternate; /* 漂浮動畫 */
        }

        body::before {
            width: 300px;
            height: 300px;
            top: -100px;
            left: -100px;
            animation-delay: 0s;
        }

        body::after {
            width: 400px;
            height: 400px;
            bottom: -150px;
            right: -150px;
            animation-delay: 2s;
        }

        @keyframes floatBubble {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, -30px) scale(1.08); }
            100% { transform: translate(0, 0) scale(1); }
        }

        .main-card {
            background-color: rgba(255, 255, 255, 0.98); /* 近乎白色，提升質感 */
            border-radius: 35px; /* 更圓潤的圓角 */
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4); /* 更深邃的陰影 */
            padding: 50px; /* 增加內邊距 */
            width: 95%;
            max-width: 900px; /* 增加最大寬度 */
            text-align: center;
            border: 5px solid #80c7f2; /* 更具活力的淺藍色邊框 */
            position: relative;
            z-index: 1;
            transform: scale(0.95); /* 稍微縮小，看起來更精緻 */
            animation: fadeInScale 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; /* 載入動畫 */
            box-sizing: border-box;
            opacity: 0; /* 預設隱藏，由動畫顯示 */
            /* 確保內容可以滾動 */
            overflow-y: auto; 
            max-height: 95vh; /* 限制卡片最大高度，讓其內容可滾動 */
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.7);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        h1 {
            font-family: 'Noto Sans TC', sans-serif;
            color: #0056b3;
            margin-bottom: 40px;
            font-size: 4.5em; /* 增大標題字體 */
            text-shadow: 4px 4px 8px rgba(0,0,0,0.3);
            letter-spacing: 3px;
            background: linear-gradient(to right, #007bff, #00c6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900; /* 加粗 */
            animation: pulseText 2s infinite alternate; /* 標題脈衝動畫 */
        }

        @keyframes pulseText {
            0% { transform: scale(1); text-shadow: 4px 4px 8px rgba(0,0,0,0.3); }
            100% { transform: scale(1.02); text-shadow: 6px 6px 12px rgba(0,0,0,0.4); }
        }

        h2 {
            font-family: 'Noto Sans TC', sans-serif;
            color: #007bff;
            font-size: 3em; /* 增大字體 */
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.15);
            font-weight: 700;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding: 15px 0;
            border-bottom: 2px dashed #e0e0e0; /* 虛線分隔線 */
        }

        .score-area, .timer-area {
            font-size: 2em; /* 增大字體 */
            font-weight: bold;
            color: #28a745; /* 綠色 */
            background-color: #e6ffe6; /* 淺綠背景 */
            padding: 12px 25px;
            border-radius: 15px; /* 更圓潤 */
            border: 3px solid #5cb85c; /* 深一點的綠色邊框 */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* 更明顯陰影 */
            min-width: 180px; /* 確保寬度 */
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounceIn 0.8s ease-out; /* 載入動畫 */
        }

        .timer-area {
            color: #dc3545; /* 紅色 */
            background-color: #ffe6e6; /* 淺紅背景 */
            border: 3px solid #dc3545;
        }

        .timer-area.time-low {
            color: #ff0000;
            animation: pulseRed 0.8s infinite alternate;
        }

        @keyframes pulseRed {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.08); opacity: 0.8; }
        }

        .question-area {
            background-color: #f0f8ff; /* 淺藍色背景，更柔和 */
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 40px;
            border: 3px solid #b3e5fc; /* 淺藍色邊框 */
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1); /* 更深邃的內陰影 */
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center; /* 讓內容垂直居中 */
            align-items: center;
        }

        #question-text {
            font-size: 2.8em; /* 增大題目字體 */
            margin-bottom: 30px;
            color: #1a4266; /* 深藍色 */
            line-height: 1.6;
            font-weight: bold;
            text-align: center; /* 文字居中 */
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        /* 圖片題目樣式 */
        #question-image {
            max-width: 90%;
            max-height: 250px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            margin-bottom: 25px;
            border: 4px solid #fff; /* 白色邊框 */
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr; /* 預設一列 */
            gap: 25px; /* 增加選項間距 */
            width: 100%;
        }

        .option-button {
            background-color: #64b5f6; /* 活力藍色 */
            color: white;
            border: none;
            padding: 25px 35px; /* 增大按鈕大小 */
            border-radius: 15px; /* 更圓潤 */
            font-size: 1.8em; /* 增大選項字體 */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            word-wrap: break-word;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* 按鈕陰影 */
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase; /* 大寫，更具遊戲感 */
        }

        .option-button:hover:not(:disabled) {
            background-color: #2196f3; /* 略深藍色 */
            transform: translateY(-7px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.35);
        }

        .option-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .option-button:disabled {
            opacity: 0.6; /* 禁用時更透明 */
            cursor: not-allowed;
        }

        .option-button.correct {
            background-color: #4caf50; /* 綠色，表示正確 */
            animation: bounceIn 0.6s ease-out forwards; /* 答對動畫 */
        }

        .option-button.wrong {
            background-color: #ff5722; /* 活力橘紅色，表示錯誤 */
            animation: shake 0.4s ease-in-out; /* 答錯動畫 */
        }

        /* 填充題輸入框樣式 */
        #fill-in-input {
            width: 80%;
            padding: 22px;
            border: 4px solid #a0c4ff;
            border-radius: 15px;
            font-size: 2em;
            text-align: center;
            margin-top: 25px;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.1);
            transition: border-color 0.3s ease;
            font-weight: bold;
            color: #333;
        }
        #fill-in-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.1), 0 0 15px rgba(0,123,255,0.5); /* 聚焦時發光 */
        }
        #fill-in-submit-button {
            margin-top: 30px;
            background-color: #28a745; /* 綠色 */
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 1.8em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        #fill-in-submit-button:hover {
            background-color: #218838;
            transform: translateY(-5px);
            box-shadow: 0 9px 18px rgba(0,0,0,0.3);
        }

        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        .feedback-text {
            font-size: 1.8em;
            margin-top: 30px;
            font-weight: bold;
            color: #e91e63; /* 醒目的粉色 */
            min-height: 40px;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .controls {
            margin-top: 40px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 25px; /* 增加按鈕間距 */
        }

        .btn {
            color: white;
            border: none;
            padding: 20px 40px; /* 增大按鈕大小 */
            border-radius: 12px;
            font-size: 1.8em; /* 增大按鈕字體 */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            min-width: 200px; /* 確保按鈕有最小寬度 */
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 9px 18px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn.primary-btn {
            background-color: #007bff; /* 藍色，主要行動 */
        }
        .btn.primary-btn:hover { background-color: #0056b3; }

        .btn.success-btn {
            background-color: #28a745; /* 綠色，成功或前進 */
        }
        .btn.success-btn:hover { background-color: #218838; }

        .btn.danger-btn {
            background-color: #dc3545; /* 紅色，危險或重置 */
        }
        .btn.danger-btn:hover { background-color: #c82333; }

        .btn.submit-btn {
            background-color: #673ab7; /* 紫色 */
        }
        .btn.submit-btn:hover { background-color: #512da8; }

        .btn.leaderboard-btn {
            background-color: #ff9800; /* 橘色 */
        }
        .btn.leaderboard-btn:hover { background-color: #fb8c00; }

        .btn.return-btn {
            background-color: #78909c; /* 淺灰色 */
        }
        .btn.return-btn:hover { background-color: #546e7a; }

        .hidden {
            display: none !important;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        /* 排行榜樣式 */
        .leaderboard-container {
            border: 5px solid #ffb74d; /* 更清晰的橘色邊框 */
        }

        .leaderboard-container h2 {
            color: #ff9800;
            font-size: 3.2em; /* 增大字體 */
            margin-bottom: 30px;
        }
        
        /* 排行榜難度切換按鈕組 */
        .leaderboard-difficulty-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            gap: 10px;
        }
        .leaderboard-difficulty-tabs button {
            background-color: #a8dadc;
            color: #1d3557;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .leaderboard-difficulty-tabs button.active {
            background-color: #457b9d;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .leaderboard-difficulty-tabs button:hover:not(.active) {
            background-color: #80c7f2;
            transform: translateY(-2px);
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .leaderboard-list li {
            background-color: #fff3e0;
            margin-bottom: 15px; /* 增加間距 */
            padding: 18px 30px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5em; /* 增大字體 */
            border: 2px solid #ffcc80;
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
            font-weight: bold;
            animation: slideInLeft 0.5s ease-out forwards;
            opacity: 0;
        }

        @keyframes slideInLeft {
            0% { transform: translateX(-50px); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateX(0); opacity: 1; }
        }
        /* 給列表項添加延遲，使它們依次出現 */
        .leaderboard-list li:nth-child(1) { animation-delay: 0.1s; }
        .leaderboard-list li:nth-child(2) { animation-delay: 0.2s; }
        .leaderboard-list li:nth-child(3) { animation-delay: 0.3s; }
        .leaderboard-list li:nth-child(4) { animation-delay: 0.4s; }
        .leaderboard-list li:nth-child(5) { animation-delay: 0.5s; }
        .leaderboard-list li:nth-child(6) { animation-delay: 0.6s; }
        .leaderboard-list li:nth-child(7) { animation-delay: 0.7s; }
        .leaderboard-list li:nth-child(8) { animation-delay: 0.8s; }
        .leaderboard-list li:nth-child(9) { animation-delay: 0.9s; }
        .leaderboard-list li:nth-child(10) { animation-delay: 1.0s; }


        .leaderboard-list li:first-child {
            background: linear-gradient(to right, #ffd700, #ffc000); /* 第一名特別色 - 金色漸變 */
            color: #8B4513; /* 深棕色文字 */
            border-color: #ffa500;
            box-shadow: 0 8px 16px rgba(0,0,0,0.25);
            font-size: 1.8em;
            transform: scale(1.05);
            transition: transform 0.3s;
        }
        .leaderboard-list li:first-child:hover { transform: scale(1.08); }

        .leaderboard-list li:nth-child(2) {
            background: linear-gradient(to right, #c0c0c0, #a9a9a9); /* 第二名特別色 - 銀色漸變 */
            color: #333;
            border-color: #999;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        .leaderboard-list li:nth-child(3) {
            background: linear-gradient(to right, #cd7f32, #b85f26); /* 第三名特別色 - 銅色漸變 */
            color: white;
            border-color: #a04e17;
            box-shadow: 0 5px 10px rgba(0,0,0,0.18);
        }

        .leaderboard-list li span:first-child {
            font-weight: bold;
            color: #d84315;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }
        .leaderboard-list li span:last-child {
            color: #00796b;
            font-size: 1.1em;
        }
        /* 特殊處理前三名的文字顏色 */
        .leaderboard-list li:first-child span:first-child { color: #8B4513; }
        .leaderboard-list li:first-child span:last-child { color: #8B4513; }
        .leaderboard-list li:nth-child(2) span { color: #333; }
        .leaderboard-list li:nth-child(3) span { color: white; }


        /* 模式選擇介面 (首頁) */
        .level-selection-container {
            gap: 35px; /* 增加間距 */
            /* 首頁專屬背景和效果 */
            /* 如果有 images/main_bg.png 會使用它，否則使用 CSS 漸變 */
            /* background: url('images/main_bg.png') no-repeat center center/cover; */
            padding: 60px;
            border-radius: 40px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
            animation: fadeInScale 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            position: relative;
            overflow: hidden; /* 確保背景圖案不溢出 */
        }
        /* 首頁背景疊加層，增加質感 */
        .level-selection-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 100%);
            z-index: 2;
            pointer-events: none;
            border-radius: 40px;
        }

        .level-selection-container h1 {
            font-size: 5em; /* 首頁標題更大 */
            margin-bottom: 50px;
            position: relative;
            z-index: 3;
            color: #fff; /* 標題顏色可變為白色以適應背景 */
            -webkit-text-stroke: 2px #0056b3; /* 描邊增加對比 */
        }
        .level-selection-container h2 {
            font-size: 3.5em;
            color: #f8f9fa; /* 淺色字體，更好看 */
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            margin-bottom: 40px;
            position: relative;
            z-index: 3;
        }

        .mode-button, .level-button {
            background-color: #1e88e5; /* 藍色系 */
            color: white;
            border: none;
            padding: 28px 55px; /* 增大按鈕大小 */
            border-radius: 18px; /* 更圓潤 */
            font-size: 2.5em; /* 增大字體 */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 10px 20px rgba(0,0,0,0.35);
            width: 80%; /* 讓按鈕寬度一致 */
            max-width: 400px;
            font-weight: bold;
            letter-spacing: 1.5px;
            position: relative;
            z-index: 3;
            background: linear-gradient(45deg, #42a5f5, #1976d2); /* 按鈕漸變色 */
            border: 2px solid #64b5f6;
        }
        .mode-button:hover, .level-button:hover {
            background-color: #1565c0;
            transform: translateY(-8px) scale(1.02); /* 更大的上移和微縮放效果 */
            box-shadow: 0 15px 30px rgba(0,0,0,0.45);
            background: linear-gradient(45deg, #1976d2, #42a5f5); /* hover 時顏色反向 */
            border-color: #2196f3;
        }

        /* 難度選擇下拉選單樣式 */
        #difficultySelect {
            width: 80%;
            max-width: 300px;
            padding: 15px 25px;
            font-size: 1.8em;
            border: 3px solid #007bff;
            border-radius: 12px;
            background-color: #e0f2f7;
            color: #333;
            appearance: none; /* 移除原生樣式 */
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            margin-bottom: 25px; /* 增加與按鈕的間距 */
            text-align-last: center; /* 讓文字居中 */
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.9a17.7%2017.7%200%200%200-25.3%200L146.2%20185.3%2030.7%2069.9A17.7%2017.7%200%200%200%205.4%2095.2l120.5%20115.4c6.9%206.6%2017.8%206.6%2024.7%200L287%2095.2a17.7%2017.7%200%200%200%200-25.3z%22%2F%3E%3C%2Fsvg%3E'); /* 下拉箭頭 */
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 1.5em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #difficultySelect:hover {
            border-color: #0056b3;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        #difficultySelect:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 4px rgba(0,123,255,0.25);
        }


        /* 多人對戰大廳 */
        .multiplayer-lobby {
            border: 5px solid #a0c4ff;
        }
        .lobby-controls {
            gap: 25px;
            margin-bottom: 40px;
        }
        #playerNameInput {
            padding: 18px 25px;
            border: 3px solid #a0c4ff;
            border-radius: 12px;
            font-size: 1.6em;
            width: calc(100% - 50px); /* 考慮 padding */
            max-width: 350px;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.1);
            font-weight: bold;
        }

        .room-list-container {
            background-color: #f0f8ff;
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #bbdefb;
            max-height: 400px; /* 限制高度，可滾動 */
            overflow-y: auto; /* 允許滾動 */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.08);
        }
        #availableRoomsList li {
            background-color: #e3f2fd;
            margin-bottom: 15px;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 1.4em;
            border: 2px solid #90caf9;
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }
        #availableRoomsList li:hover {
            transform: translateX(5px);
        }

        #availableRoomsList li button {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        #availableRoomsList li button:hover {
            background-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

        /* 遊戲房間介面 */
        .game-room-container {
            border: 5px solid #a0c4ff;
        }
        .game-room-container .players-info {
            margin-bottom: 35px;
            font-size: 1.6em;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .game-room-container .players-info p {
            background-color: #e0f2f7;
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid #b2ebf2;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            font-weight: bold;
        }
        #room-status-message {
            font-size: 1.8em;
            margin-bottom: 30px;
            color: #e91e63;
            font-weight: bold;
        }

        /* 虛擬角色區塊 */
        .mascot-area {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 200px; /* 增大角色 */
            height: 230px;
            z-index: 2;
            pointer-events: none;
            animation: bounceMascot 3s infinite ease-in-out;
        }

        .mascot-area img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(10px 10px 20px rgba(0,0,0,0.4)); /* 更明顯的陰影 */
        }

        @keyframes bounceMascot {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* 虛擬角色表情文字泡泡 */
        .mascot-speech-bubble {
            position: absolute;
            top: -70px; /* 根據圖片調整位置 */
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffeb3b; /* 鮮黃色泡泡 */
            border: 4px solid #fbc02d; /* 更明顯的邊框 */
            border-radius: 25px; /* 更圓潤 */
            padding: 12px 18px;
            font-size: 1.3em;
            color: #333;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            pointer-events: none;
            z-index: 10;
            font-weight: bold;
            box-shadow: 0 5px 10px rgba(0,0,0,0.25);
            text-align: center;
        }
        .mascot-speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 30px;
            height: 30px;
            background-color: #ffeb3b;
            border-right: 4px solid #fbc02d;
            border-bottom: 4px solid #fbc02d;
            z-index: 1;
        }
        .mascot-speech-bubble.active {
            opacity: 1;
            transform: translateX(-50%) translateY(-20px); /* 稍微上移 */
        }

        /* 連擊提示 */
        .combo-streak {
            font-family: 'Noto Sans TC', sans-serif;
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 7em; /* 增大字體 */
            color: #ffcc00;
            text-shadow: 6px 6px 12px rgba(0,0,0,0.7);
            -webkit-text-stroke: 4px #d4af37;
            pointer-events: none;
            z-index: 10;
            font-weight: 900;
            opacity: 0;
        }

        @keyframes comboPop {
            0% { transform: translate(-50%, 20px) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, 0px) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, 0px) scale(1); opacity: 0.9; }
        }


        /* RWD 調整 */
        @media (min-width: 768px) {
            .options-container {
                grid-template-columns: 1fr 1fr; /* 兩列 */
            }
        }

        @media (max-width: 992px) {
            .main-card {
                padding: 40px;
                border-radius: 30px;
            }
            h1 { font-size: 4em; margin-bottom: 35px; }
            h2 { font-size: 2.5em; margin-bottom: 25px; }
            .header-info { margin-bottom: 30px; }
            .score-area, .timer-area { font-size: 1.8em; padding: 10px 20px; min-width: 160px; }
            .question-area { padding: 35px; margin-bottom: 35px; min-height: 220px; }
            #question-text { font-size: 2.2em; margin-bottom: 25px; }
            #question-image { max-height: 200px; }
            .option-button { font-size: 1.6em; padding: 20px 30px; border-radius: 12px; }
            #fill-in-input { font-size: 1.8em; padding: 18px; border-radius: 12px; }
            #fill-in-submit-button { font-size: 1.6em; padding: 18px 35px; border-radius: 10px; }
            .feedback-text { font-size: 1.6em; margin-top: 25px; min-height: 35px; }
            .controls { margin-top: 35px; gap: 20px; }
            .btn { font-size: 1.6em; padding: 18px 35px; border-radius: 10px; min-width: 180px; }
            .leaderboard-list li { font-size: 1.3em; padding: 15px 25px; border-radius: 10px; }
            .leaderboard-list li:first-child { font-size: 1.5em; }
            .level-selection-container { padding: 50px; border-radius: 35px; }
            .level-selection-container h1 { font-size: 4.5em; margin-bottom: 40px; }
            .level-selection-container h2 { font-size: 3em; margin-bottom: 30px; }
            .mode-button, .level-button { font-size: 2.2em; padding: 25px 50px; border-radius: 15px; max-width: 380px; }
            #difficultySelect { font-size: 1.6em; padding: 12px 20px; max-width: 280px; }
            #playerNameInput { font-size: 1.4em; padding: 15px 20px; }
            #availableRoomsList li { font-size: 1.25em; padding: 18px 25px; border-radius: 12px; }
            #availableRoomsList li button { padding: 12px 20px; }
            .game-room-container .players-info { font-size: 1.4em; gap: 15px; }
            #room-status-message { font-size: 1.6em; margin-bottom: 25px; }
            .mascot-area { width: 180px; height: 210px; bottom: 25px; left: 25px; }
            .mascot-speech-bubble { font-size: 1.2em; top: -60px; padding: 10px 15px; border-radius: 20px; }
            .combo-streak { font-size: 6em; }
        }

        @media (max-width: 767px) {
            body { font-size: 14px; }
            .main-card {
                padding: 30px;
                border-radius: 25px;
            }
            h1 { font-size: 3.5em; margin-bottom: 30px; }
            h2 { font-size: 2em; margin-bottom: 15px; }
            .header-info { flex-direction: column; gap: 15px; margin-bottom: 25px; }
            .score-area, .timer-area { width: 100%; max-width: 250px; font-size: 1.5em; padding: 8px 15px; }
            .question-area { padding: 25px; margin-bottom: 25px; min-height: 180px; }
            #question-text { font-size: 1.8em; margin-bottom: 20px; min-height: 120px; }
            #question-image { max-height: 150px; }
            .options-container { grid-template-columns: 1fr; gap: 15px; }
            .option-button { font-size: 1.3em; padding: 15px 20px; border-radius: 10px; }
            #fill-in-input { font-size: 1.5em; padding: 12px; border-radius: 10px; }
            #fill-in-submit-button { font-size: 1.3em; padding: 12px 25px; border-radius: 8px; }
            .feedback-text { font-size: 1.4em; margin-top: 20px; min-height: 30px; }
            .controls { margin-top: 30px; gap: 15px; }
            .btn { font-size: 1.3em; padding: 15px 25px; border-radius: 8px; min-width: 150px; }
            .leaderboard-list li { font-size: 1.2em; padding: 12px 20px; border-radius: 8px; }
            .leaderboard-list li:first-child { font-size: 1.4em; }
            .level-selection-container { padding: 40px; border-radius: 30px; }
            .level-selection-container h1 { font-size: 3.5em; margin-bottom: 35px; }
            .level-selection-container h2 { font-size: 2.5em; margin-bottom: 30px; }
            .mode-button, .level-button { font-size: 2em; padding: 25px 50px; border-radius: 15px; max-width: 350px; }
            #difficultySelect { font-size: 1.4em; padding: 10px 15px; max-width: 250px; margin-bottom: 20px;}
            #playerNameInput { font-size: 1.4em; padding: 15px 20px; }
            #availableRoomsList li { font-size: 1.1em; padding: 15px 20px; border-radius: 12px; }
            #availableRoomsList li button { padding: 10px 15px; }
            .game-room-container .players-info { font-size: 1.2em; gap: 10px; }
            #room-status-message { font-size: 1.4em; margin-bottom: 20px; }
            .mascot-area { width: 150px; height: 170px; bottom: 20px; left: 20px; }
            .mascot-speech-bubble { font-size: 1.1em; top: -55px; padding: 8px 12px; border-radius: 18px; }
            .combo-streak { font-size: 5em; }
        }

        @media (max-width: 480px) {
            body { font-size: 12px; }
            .main-card {
                padding: 20px;
                border-radius: 20px;
            }
            h1 { font-size: 3em; margin-bottom: 25px; }
            h2 { font-size: 1.8em; margin-bottom: 15px; }
            .header-info { gap: 10px; margin-bottom: 20px; }
            .score-area, .timer-area { font-size: 1.3em; padding: 6px 12px; }
            .question-area { padding: 20px; margin-bottom: 20px; min-height: 150px; }
            #question-text { font-size: 1.6em; margin-bottom: 15px; min-height: 100px; }
            #question-image { max-height: 120px; }
            .options-container { grid-template-columns: 1fr; gap: 10px; }
            .option-button { font-size: 1.1em; padding: 12px 15px; border-radius: 8px; }
            #fill-in-input { font-size: 1.3em; padding: 10px; border-radius: 8px; }
            #fill-in-submit-button { font-size: 1.1em; padding: 10px 20px; border-radius: 6px; }
            .feedback-text { font-size: 1.2em; margin-top: 15px; min-height: 25px; }
            .controls { margin-top: 25px; gap: 10px; }
            .btn { font-size: 1.1em; padding: 12px 20px; border-radius: 6px; min-width: 120px; }
            .leaderboard-list li { font-size: 1em; padding: 10px 15px; border-radius: 6px; }
            .leaderboard-list li:first-child { font-size: 1.2em; }
            .level-selection-container { padding: 30px; border-radius: 25px; }
            .level-selection-container h1 { font-size: 3em; margin-bottom: 30px; }
            .level-selection-container h2 { font-size: 2.2em; margin-bottom: 20px; }
            .mode-button, .level-button { font-size: 1.8em; padding: 18px 35px; border-radius: 10px; max-width: 300px; }
            #difficultySelect { font-size: 1.2em; padding: 8px 12px; max-width: 200px; margin-bottom: 15px;}
            #playerNameInput { font-size: 1em; padding: 10px 15px; }
            #availableRoomsList li { font-size: 0.95em; padding: 12px 15px; border-radius: 8px; }
            #availableRoomsList li button { padding: 8px 12px; }
            .game-room-container .players-info { font-size: 1em; gap: 8px; }
            #room-status-message { font-size: 1.2em; margin-bottom: 15px; }
            .mascot-area { width: 120px; height: 140px; bottom: 15px; left: 15px; }
            .mascot-speech-bubble { font-size: 1em; top: -45px; padding: 6px 10px; border-radius: 15px; }
            .combo-streak { font-size: 4em; }
        }

    </style>
</head>
<body>
    <audio id="correctSound" src="sounds/correct.mp3" preload="auto"></audio>
    <audio id="wrongSound" src="sounds/wrong.mp3" preload="auto"></audio>
    <audio id="timeWarningSound" src="sounds/time_warning.mp3" preload="auto"></audio>
    <audio id="backgroundMusic" src="sounds/bg_music.mp3" loop preload="auto"></audio>

    <div class="mascot-area">
        <img id="mascotImage" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSPJyZtdf4AIj0jMgdP1OOW3Wn3WfI_wC6lZw&s" alt="客家小精靈">
        <div id="mascotSpeechBubble" class="mascot-speech-bubble"></div>
    </div>

    <div id="comboStreakDisplay" class="combo-streak hidden"></div>

    <div class="main-card level-selection-container" id="levelSelectionContainer">
        <h1>客語認證考題對對碰</h1>
        <h2>歡迎來到客語的世界！</h2>
        <p style="font-size: 1.5em; color: #5a5a5a; margin-bottom: 30px; line-height: 1.8;">
            透過輕鬆有趣的遊戲，學習客家單字、詞彙和諺語。<br>
            挑戰自己，成為客語大師吧！
        </p>
        <div class="controls" style="margin-top: 0;">
            <button class="mode-button" data-mode="single">單人挑戰</button>
            <select id="difficultySelect">
                <option value="easy">簡單</option>
                <option value="medium">中等</option>
                <option value="hard">困難</option>
            </select>
            <button class="mode-button" data-mode="multi">多人對戰</button>
            <button id="show-leaderboard-initial" class="btn leaderboard-btn">查看客語大師榜</button>
        </div>
    </div>

    <div class="main-card game-container hidden" id="gameContainer">
        <div class="header-info">
            <div class="score-area">分數: <span id="score">0</span> / <span id="totalQuestions">10</span></div>
            <div class="timer-area">倒數: <span id="timer">30</span> 秒</div>
        </div>

        <div class="question-area">
            <div id="question-text"></div>
            <img id="question-image" class="hidden" alt="題目圖片">
            <div id="options-container" class="options-container">
                </div>
            <input type="text" id="fill-in-input" class="hidden" placeholder="請輸入客家字">
            <button id="fill-in-submit-button" class="btn submit-btn hidden">提交答案</button>
        </div>
        <div id="feedback-text" class="feedback-text"></div>

        <div class="controls">
            <button id="nextQuestionBtn" class="btn success-btn hidden">下一題</button>
            <button id="resetGameBtn" class="btn danger-btn hidden">重新開始</button>
            <button id="showLeaderboardBtn" class="btn leaderboard-btn hidden">查看客語大師榜</button>
            <button id="returnToHomeBtn" class="btn return-btn hidden">返回主選單</button>
        </div>
    </div>

    <div class="main-card leaderboard-container hidden" id="leaderboardContainer">
        <h2>客語大師榜</h2>
        <!-- 排行榜難度切換按鈕 -->
        <div class="leaderboard-difficulty-tabs">
            <button id="leaderboardBtnEasy" data-difficulty="easy" class="active">簡單</button>
            <button id="leaderboardBtnMedium" data-difficulty="medium">中等</button>
            <button id="leaderboardBtnHard" data-difficulty="hard">困難</button>
        </div>
        <ul id="leaderboardList" class="leaderboard-list">
            <!-- 排行榜分數將動態插入此處 -->
        </ul>
        <div class="controls">
            <button id="returnFromLeaderboardBtn" class="btn return-btn">返回主選單</button>
        </div>
    </div>

    <div class="main-card multiplayer-lobby hidden" id="multiplayerLobbyContainer">
        <h2>多人對戰大廳</h2>
        <div class="lobby-controls controls">
            <input type="text" id="playerNameInput" placeholder="輸入你的暱稱">
            <button id="createRoomBtn" class="btn primary-btn">建立新房間</button>
            <button id="refreshRoomsBtn" class="btn success-btn">刷新房間列表</button>
        </div>
        <h3>可加入的房間：</h3>
        <div class="room-list-container">
            <ul id="availableRoomsList">
                </ul>
        </div>
        <div class="controls">
            <button id="returnFromLobbyBtn" class="btn return-btn">返回主選單</button>
        </div>
    </div>

    <div class="main-card game-room-container hidden" id="gameRoomContainer">
        <h2>遊戲房間：<span id="roomNameDisplay"></span></h2>
        <div class="players-info">
            <p>房主: <span id="hostPlayerName"></span></p>
            <p>玩家: <span id="clientPlayerName"></span></p>
        </div>
        <p id="room-status-message">等待其他玩家加入...</p>
        <div class="controls">
            <button id="startGameBtn" class="btn success-btn hidden">開始遊戲</button>
            <button id="leaveRoomBtn" class="btn danger-btn">離開房間</button>
        </div>
    </div>

    <script>
        // Firebase 配置資訊
        // **請務必將此處的 YOUR_FIREBASE_CONFIG 替換為你在 Firebase 專案中實際取得的設定資訊**
        // 前往 Firebase Console -> Project settings -> General -> Your apps -> Firebase SDK snippet -> Config
        const firebaseConfig = {
            apiKey: "AIzaSyCVvM_kfmLy68NK-ILq63me50Gn6ROiWJ8",
            authDomain: "snake-8bc6a.firebaseapp.com",
            databaseURL: "https://snake-8bc6a-default-rtdb.firebaseio.com",
            projectId: "snake-8bc6a",
            storageBucket: "snake-8bc6a.firebasestorage.app",
            messagingSenderId: "800157644026",
            appId: "1:800157644026:web:3b90c15789cacfef918543",
            measurementId: "G-NJ34S53TSV"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // 取得 Firestore 實例

        // HTML 元素選擇器
        const levelSelectionContainer = document.getElementById('levelSelectionContainer');
        const gameContainer = document.getElementById('gameContainer');
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const multiplayerLobbyContainer = document.getElementById('multiplayerLobbyContainer');
        const gameRoomContainer = document.getElementById('gameRoomContainer');

        const difficultySelect = document.getElementById('difficultySelect'); // 新增難度選擇下拉選單

        const scoreDisplay = document.getElementById('score');
        const totalQuestionsDisplay = document.getElementById('totalQuestions');
        const timerDisplay = document.getElementById('timer');
        const questionText = document.getElementById('question-text');
        const questionImage = document.getElementById('question-image');
        const optionsContainer = document.getElementById('options-container');
        const fillInInput = document.getElementById('fill-in-input');
        const fillInSubmitButton = document.getElementById('fill-in-submit-button');
        const feedbackText = document.getElementById('feedback-text');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const showLeaderboardBtn = document.getElementById('showLeaderboardBtn');
        const returnToHomeBtn = document.getElementById('returnToHomeBtn');

        const showLeaderboardInitialBtn = document.getElementById('show-leaderboard-initial');
        const leaderboardList = document.getElementById('leaderboardList');
        const returnFromLeaderboardBtn = document.getElementById('returnFromLeaderboardBtn');

        // Multiplayer elements
        const playerNameInput = document.getElementById('playerNameInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const refreshRoomsBtn = document.getElementById('refreshRoomsBtn');
        const availableRoomsList = document.getElementById('availableRoomsList');
        const returnFromLobbyBtn = document.getElementById('returnFromLobbyBtn');
        const roomNameDisplay = document.getElementById('roomNameDisplay');
        const hostPlayerName = document.getElementById('hostPlayerName');
        const clientPlayerName = document.getElementById('clientPlayerName');
        const roomStatusMessage = document.getElementById('room-status-message');
        const startGameBtn = document.getElementById('startGameBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');

        const mascotImage = document.getElementById('mascotImage');
        const mascotSpeechBubble = document.getElementById('mascotSpeechBubble');
        const comboStreakDisplay = document.getElementById('comboStreakDisplay');

        // 音效
        const correctSound = document.getElementById('correctSound');
        const wrongSound = document.getElementById('wrongSound');
        const timeWarningSound = document.getElementById('timeWarningSound');
        const backgroundMusic = document.getElementById('backgroundMusic');

        // 遊戲狀態變數
        let currentMode = ''; // 'single' or 'multi'
        let currentLevel = 'easy'; // 預設難度為 'easy'
        let currentQuestionIndex = 0;
        let score = 0;
        let timer;
        let timeLeft = 30; // 每題秒數
        let gameActive = false;
        let questions = []; // 存放題目的陣列
        let currentPlayerName = '匿名玩家'; // 預設玩家名稱
        let currentRoomId = null; // 當前房間 ID
        let seconds = 0; // 用於排行榜的時間追蹤

        let comboStreak = 0;
        let mascotSpeechTimeout;

        // 題目資料 (根據規劃書調整，提供客語詞彙和諺語的範例)
        const allQuestions = {
            // 調整 easy 和 medium 詞彙數量以確保至少有 10 題
            easy: [ // 確保至少 10 題
                { type: 'multiple-choice', question: '「食飽」是什麼意思？', options: ['吃飽', '吃慢點', '吃好', '好吃'], answer: '吃飽', pinyin: 'sii-bau' },
                { type: 'multiple-choice', question: '「𠊎」是什麼意思？', options: ['你', '他', '我', '我們'], answer: '我', pinyin: 'ngai' },
                { type: 'multiple-choice', question: '「恁好」是什麼意思？', options: ['很好', '不好', '謝謝', '對不起'], answer: '很好', pinyin: 'an ho' },
                { type: 'multiple-choice', question: '「承蒙」是什麼意思？', options: ['謝謝', '再見', '你好', '不客氣'], answer: '謝謝', pinyin: 'sang mung' },
                { type: 'multiple-choice', question: '「先生」是什麼意思？', options: ['老師', '醫生', '警察', '學生'], answer: '老師', pinyin: 'sien sang' },
                { type: 'fill-in', question: '「吃飯」客語是「食___」。', answer: '飯', pinyin: 'sii fan' },
                { type: 'fill-in', question: '「喝水」客語是「食___」。', answer: '水', pinyin: 'sii sui' },
                { type: 'fill-in', question: '「睡覺」客語是「睏___」。', answer: '覺', pinyin: 'kun gau' },
                { type: 'fill-in', question: '「學校」客語是「學___」。', answer: '堂', pinyin: 'hok tong' },
                { type: 'fill-in', question: '「市場」客語是「菜___」。', answer: '市', pinyin: 'coi si' },
                { type: 'image-guess', image: 'https://placehold.co/150x150/aabbcc/ffffff?text=Apple', question: '圖片中的水果客語是「蘋果」，請問其漢語是？', options: ['李子', '蘋果', '香蕉', '橘子'], answer: '蘋果' },
                { type: 'image-guess', image: 'https://placehold.co/150x150/aabbcc/ffffff?text=Mountain', question: '圖片中的地貌客語是「山」，請問其漢語是？', options: ['河', '山', '海', '田'], answer: '山' }
            ],
            medium: [ // 確保至少 10 題
                { type: 'multiple-choice', question: '「走衝」是什麼意思？', options: ['跑得快', '趕緊走', '衝動', '努力奮鬥'], answer: '努力奮鬥', pinyin: 'zeu cung' },
                { type: 'multiple-choice', question: '「遽遽仔」是什麼意思？', options: ['快一點', '慢慢來', '一下子', '很遠'], answer: '快一點', pinyin: 'gi gi e' },
                { type: 'multiple-choice', question: '「頭擺」是什麼意思？', options: ['現在', '以前', '將來', '昨天'], answer: '以前', pinyin: 'teu bai' },
                { type: 'multiple-choice', question: '「打幫手」是什麼意思？', options: ['打架', '幫助', '幫忙', '打招呼'], answer: '幫忙', pinyin: 'da bong seu' },
                { type: 'multiple-choice', question: '「禾埕」是什麼意思？', options: ['稻埕', '客廳', '廚房', '臥室'], answer: '稻埕', pinyin: 'vo tang' },
                { type: 'fill-in', question: '客語諺語：「食果子拜樹___」。', answer: '頭', pinyin: 'sit go zi bai su teu' },
                { type: 'fill-in', question: '客語中「可愛」是「惜___」。', answer: '惜', pinyin: 'siak siak' },
                { type: 'fill-in', question: '客語中「很」是「___」。', answer: '盡', pinyin: 'jin' },
                { type: 'fill-in', question: '「太陽」客語是「日___」。', answer: '頭', pinyin: 'ngit teu' },
                { type: 'fill-in', question: '「月亮」客語是「月___」。', answer: '光', pinyin: 'ngiet gong' },
                { type: 'image-guess', image: 'https://placehold.co/150x150/aabbcc/ffffff?text=Rain', question: '圖片中的天氣現象客語是「雨」，請問其漢語是？', options: ['雪', '風', '雨', '晴'], answer: '雨' },
                { type: 'multiple-choice', question: '形容事物「很漂亮」的客語是？', options: ['盡靚', '盡惡', '盡惜', '盡好'], answer: '盡靚', pinyin: 'jin liang' }
            ],
            hard: [ // 確保至少 10 題
                { type: 'multiple-choice', question: '「七坐八爬九發牙」是什麼意思？', options: ['形容嬰兒成長過程', '表示時間很快', '比喻學習循序漸進', '說人做事慢'], answer: '形容嬰兒成長過程', pinyin: 'cit zo pat pa giu fat nga' },
                { type: 'multiple-choice', question: '「有食毋過三頓」是什麼意思？', options: ['食物很少', '吃不完三餐', '比喻人生命有限，應把握時光', '表示很節儉'], answer: '比喻人生命有限，應把握時光', pinyin: 'iu sit m go sam tun' },
                { type: 'multiple-choice', question: '「人來客去」是什麼意思？', options: ['形容人際關係複雜', '比喻生意興隆', '指人來人往的景象', '表示來去匆匆'], answer: '指人來人往的景象', pinyin: 'ngin loi hak hi' },
                { type: 'multiple-choice', question: '「看生食，毋看死食」是什麼意思？', options: ['活著的時候要吃好', '不要浪費食物', '比喻要珍惜眼前機會，不要空等', '指人只看表面'], answer: '比喻要珍惜眼前機會，不要空等', pinyin: 'kon sang sit, m kon si sit' },
                { type: 'multiple-choice', question: '「雞啼狗吠」是什麼意思？', options: ['形容農村景象', '比喻吵鬧不休', '形容時間很早', '指雞犬不寧'], answer: '形容農村景象', pinyin: 'goi ti geu fi' },
                { type: 'fill-in', question: '客語諺語：「三日打魚，兩日___網」。', answer: '曝', pinyin: 'sam ngit da ngi, liong ngit pok mong' },
                { type: 'fill-in', question: '客語諺語：「毋當家毋知柴米___」。', answer: '貴', pinyin: 'm dong ga m zi cai mi gui' },
                { type: 'fill-in', question: '客語諺語：「有錢難買少年___」。', answer: '時', pinyin: 'iu cien nan mai seu nien si' },
                { type: 'fill-in', question: '客語諺語：「一樣米養百樣___」。', answer: '人', pinyin: 'it iong mi iong pak iong ngin' },
                { type: 'fill-in', question: '「逐家」的客家字是「___家」。', answer: '逐', pinyin: 'tuk ga' },
                { type: 'image-guess', image: 'https://placehold.co/150x150/aabbcc/ffffff?text=Happy', question: '這張圖片傳達的情緒客語是「歡喜」，請問其漢語是？', options: ['悲傷', '生氣', '歡喜', '害怕'], answer: '歡喜' },
                { type: 'multiple-choice', question: '形容一個人「很聰明」的客語是？', options: ['盡笨', '盡𠢕 (gau)', '盡慢', '盡堵'], answer: '盡𠢕 (gau)', pinyin: 'jin gau' },
                { type: 'image-guess', image: 'https://placehold.co/150x150/aabbcc/ffffff?text=Old', question: '這張圖片代表的年齡客語是「老」，請問其漢語是？', options: ['年輕', '中年', '老年', '兒童'], answer: '老年' },
                { type: 'multiple-choice', question: '形容天氣「很熱」的客語是？', options: ['盡寒', '盡燒', '盡涼', '盡暖'], answer: '盡燒', pinyin: 'jin sau' },
                { type: 'image-guess', image: 'https://placehold.co/150x150/aabbcc/ffffff?text=Food', question: '這張圖片代表的客語是「食」 (sii)，請問其漢語是？', options: ['玩', '走', '看', '吃'], answer: '吃' },
                { type: 'multiple-choice', question: '「打嘴鼓」是什麼意思？', options: ['打架', '聊天', '唱歌', '說笑'], answer: '聊天', pinyin: 'da zui gu' }
            ]
        };
        
        // 虛擬角色語音庫
        const mascotSpeeches = {
            neutral: "來學客語囉！",
            correct: ["答對了！你真棒！", "客語小天才就是你！", "麼介厲害！"],
            wrong: ["再想想看喔！", "沒關係，下次會更好！", "毋使愁，繼續努力！"],
            timeLow: "時間快到囉！",
            gameOver: "遊戲結束！看看你的分數！",
            leaderboard: "這些是客語大師！"
        };

        function showMascotSpeech(type) {
            let message = mascotSpeeches[type];
            if (Array.isArray(message)) {
                message = message[Math.floor(Math.random() * message.length)];
            } else if (type === 'neutral') {
                message = mascotSpeeches.neutral;
            }

            mascotSpeechBubble.textContent = message;
            mascotSpeechBubble.classList.add('active');
            clearTimeout(mascotSpeechTimeout);
            mascotSpeechTimeout = setTimeout(() => {
                mascotSpeechBubble.classList.remove('active');
            }, 3000); // 泡泡顯示3秒
        }

        // 顯示連擊數
        function showComboStreak() {
            if (comboStreak > 1) {
                comboStreakDisplay.textContent = `${comboStreak} 連擊！`;
                comboStreakDisplay.classList.remove('hidden');
                comboStreakDisplay.style.animation = 'none'; // 重置動畫
                void comboStreakDisplay.offsetWidth; // 觸發重繪
                comboStreakDisplay.style.animation = 'comboPop 0.8s ease-out forwards';
                setTimeout(() => {
                    comboStreakDisplay.classList.add('hidden');
                }, 1500); // 連擊提示顯示1.5秒
            }
        }


        // 顯示介面函數
        function showScreen(screenId) {
            const screens = [levelSelectionContainer, gameContainer, leaderboardContainer, multiplayerLobbyContainer, gameRoomContainer];
            screens.forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.remove('hidden');
                } else {
                    screen.classList.add('hidden');
                }
            });
            // 在切換畫面時，播放背景音樂（如果尚未播放）
            if (screenId === 'gameContainer' && backgroundMusic.paused) {
                backgroundMusic.play().catch(e => console.error("Error playing background music:", e));
            } else if (screenId !== 'gameContainer' && !backgroundMusic.paused) {
                 backgroundMusic.pause();
                 backgroundMusic.currentTime = 0; // 重置音樂
            }

            // 根據畫面顯示吉祥物語音
            if (screenId === 'levelSelectionContainer') {
                showMascotSpeech('neutral');
                difficultySelect.classList.remove('hidden'); // 返回主選單時顯示下拉選單
            } else if (screenId === 'leaderboardContainer') {
                showMascotSpeech('leaderboard');
                difficultySelect.classList.add('hidden'); // 遊戲或排行榜時隱藏下拉選單
            } else { // 遊戲畫面或多人模式
                difficultySelect.classList.add('hidden');
            }
        }

        // 載入題目
        function loadQuestions(level) {
            questions = [...allQuestions[level]]; // 複製一份，避免修改原始資料
            // 可以隨機打亂題目順序
            for (let i = questions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questions[i], questions[j]] = [questions[j], questions[i]];
            }
            // 限制題目數量為 10 題
            questions = questions.slice(0, 10); 
            totalQuestionsDisplay.textContent = questions.length; // 將顯示 10
        }

        // 顯示當前題目
        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame();
                return;
            }

            resetFeedback();
            const question = questions[currentQuestionIndex];
            questionText.textContent = question.question;

            // 清除之前的選項或輸入框
            optionsContainer.innerHTML = '';
            fillInInput.value = '';
            fillInInput.classList.add('hidden');
            fillInSubmitButton.classList.add('hidden');
            questionImage.classList.add('hidden');
            if (question.image) {
                 questionImage.src = question.image;
                 questionImage.classList.remove('hidden');
             } else {
                 questionImage.src = ''; // 清除圖片
             }

            // 根據題目類型顯示不同的元素
            if (question.type === 'multiple-choice' || question.type === 'image-guess') {
                optionsContainer.classList.remove('hidden');
                question.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.classList.add('option-button');
                    button.textContent = option;
                    button.dataset.index = index; // 用於識別選項
                    button.addEventListener('click', () => checkAnswer(option, question.answer, button));
                    optionsContainer.appendChild(button);
                });
            } else if (question.type === 'fill-in') {
                optionsContainer.classList.add('hidden');
                fillInInput.classList.remove('hidden');
                fillInSubmitButton.classList.remove('hidden');
                fillInSubmitButton.onclick = () => checkAnswer(fillInInput.value, question.answer);
                fillInInput.focus(); // 自動聚焦輸入框
            }

            startTimer();
            // 在顯示新題目時，確保下一題按鈕是隱藏的
            nextQuestionBtn.classList.add('hidden');
        }

        // 檢查答案
        function checkAnswer(selectedAnswer, correctAnswer, clickedButton = null) {
            if (!gameActive) return;

            stopTimer();
            gameActive = false; // 暫停遊戲直到下一題

            const isCorrect = (typeof correctAnswer === 'string')
                ? selectedAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase()
                : selectedAnswer === correctAnswer; // 處理填空題大小寫不敏感

            if (isCorrect) {
                score++;
                scoreDisplay.textContent = score;
                feedbackText.textContent = '✅ 正確！';
                feedbackText.style.color = '#4caf50'; // 綠色
                correctSound.play().catch(e => console.error("Error playing sound:", e));
                comboStreak++;
                showComboStreak();
                showMascotSpeech('correct');
            } else {
                feedbackText.textContent = `❌ 錯誤！正確答案是：${correctAnswer}`;
                feedbackText.style.color = '#ff5722'; // 紅色
                wrongSound.play().catch(e => console.error("Error playing sound:", e));
                comboStreak = 0; // 連擊中斷
                showMascotSpeech('wrong');
            }

            // 禁用所有選項按鈕或提交按鈕
            const allOptionButtons = optionsContainer.querySelectorAll('.option-button');
            allOptionButtons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent.trim().toLowerCase() === correctAnswer.trim().toLowerCase()) {
                    btn.classList.add('correct');
                } else if (btn === clickedButton) {
                    btn.classList.add('wrong');
                }
            });
            if (fillInInput) fillInInput.disabled = true;
            if (fillInSubmitButton) fillInSubmitButton.disabled = true;

            nextQuestionBtn.classList.remove('hidden');
            resetGameBtn.classList.remove('hidden');
            showLeaderboardBtn.classList.remove('hidden');
            returnToHomeBtn.classList.remove('hidden');
        }

        // 重設反饋訊息
        function resetFeedback() {
            feedbackText.textContent = '';
            feedbackText.style.color = '#e91e63'; // 重設顏色
            const allOptionButtons = optionsContainer.querySelectorAll('.option-button');
            allOptionButtons.forEach(btn => {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = false;
            });
            if (fillInInput) {
                fillInInput.disabled = false;
                fillInInput.value = ''; // 清空輸入框
            }
            if (fillInSubmitButton) fillInSubmitButton.disabled = false;
        }

        // 開始計時器
        function startTimer() {
            seconds = 0; // 重置時間
            timeLeft = 30; // 每題秒數
            timerDisplay.textContent = timeLeft;
            timerDisplay.classList.remove('time-low'); // 移除低時間樣式
            gameActive = true;

            timer = setInterval(() => {
                timeLeft--;
                seconds++; // 累計總時間
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 10 && timeLeft > 0) {
                    timerDisplay.classList.add('time-low');
                    // 確保時間警告音只播放一次，或控制播放頻率
                    if (timeLeft % 5 === 0) { // 每5秒提醒一次
                        timeWarningSound.play().catch(e => console.error("Error playing sound:", e));
                    }
                } else if (timeLeft <= 0) {
                    stopTimer();
                    checkAnswer('', '時間到！'); // 時間到自動判錯
                    gameActive = false;
                }
            }, 1000);
        }

        // 停止計時器
        function stopTimer() {
            clearInterval(timer);
        }

        // 結束遊戲
        async function endGame() {
            stopTimer();
            gameActive = false;
            feedbackText.textContent = `遊戲結束！你的分數是：${score} / ${questions.length}`;
            feedbackText.style.color = '#007bff'; // 藍色
            nextQuestionBtn.classList.add('hidden'); // 遊戲結束不顯示下一題
            resetGameBtn.classList.remove('hidden');
            showLeaderboardBtn.classList.remove('hidden');
            returnToHomeBtn.classList.remove('hidden');
            showMascotSpeech('gameOver');

            // 提示玩家輸入姓名以記錄分數
            let playerName = prompt(`恭喜你完成測驗！你的分數是 ${score}！\n請輸入你的暱稱，將分數記錄到排行榜：`);
            if (playerName) {
                // 限制暱稱長度
                playerName = playerName.trim().substring(0, 15) || '匿名玩家';
                await saveScoreToLeaderboard(playerName, score, seconds, currentLevel); // 傳遞 currentLevel
            } else {
                playerName = '匿名玩家'; // 如果取消或未輸入，使用匿名
                await saveScoreToLeaderboard(playerName, score, seconds, currentLevel); // 即使匿名也記錄分數
            }
        }

        // 重設遊戲
        function resetGame() {
            currentQuestionIndex = 0;
            score = 0;
            scoreDisplay.textContent = score;
            seconds = 0; // 重置總時間
            stopTimer();
            resetFeedback();
            nextQuestionBtn.classList.add('hidden');
            resetGameBtn.classList.add('hidden');
            showLeaderboardBtn.classList.add('hidden');
            returnToHomeBtn.classList.add('hidden');
            comboStreak = 0; // 重置連擊

            // 如果是單人模式，重新載入題目並開始
            if (currentMode === 'single') {
                loadQuestions(currentLevel); // 重新載入當前難度的題目
                displayQuestion();
            } else {
                // 多人模式的重置可能意味著返回大廳或等待房主操作
                // 這裡簡單地返回到房間等待介面
                showScreen('gameRoomContainer');
                roomStatusMessage.textContent = '遊戲已重置，等待房主開始新遊戲。';
                startGameBtn.classList.remove('hidden'); // 讓房主可以再次開始
            }
        }

        // 處理主選單模式選擇
        document.querySelectorAll('.mode-button').forEach(button => {
            button.addEventListener('click', (event) => {
                currentMode = event.target.dataset.mode;
                if (currentMode === 'single') {
                    // 單人模式讀取下拉選單的難度
                    currentLevel = difficultySelect.value;
                    loadQuestions(currentLevel);
                    showScreen('gameContainer');
                    displayQuestion();
                } else if (currentMode === 'multi') {
                    // 多人模式進入大廳
                    showScreen('multiplayerLobbyContainer');
                    refreshRoomList(); // 進入大廳時刷新房間列表
                }
            });
        });

        // 排行榜相關功能
        showLeaderboardInitialBtn.addEventListener('click', () => {
            showScreen('leaderboardContainer');
            // 預設顯示簡單難度的排行榜
            leaderboardBtnEasy.classList.add('active');
            leaderboardBtnMedium.classList.remove('active');
            leaderboardBtnHard.classList.remove('active');
            loadLeaderboard('easy');
        });

        showLeaderboardBtn.addEventListener('click', () => {
            showScreen('leaderboardContainer');
            // 預設顯示簡單難度的排行榜
            leaderboardBtnEasy.classList.add('active');
            leaderboardBtnMedium.classList.remove('active');
            leaderboardBtnHard.classList.remove('active');
            loadLeaderboard('easy');
        });

        returnFromLeaderboardBtn.addEventListener('click', () => {
            showScreen('levelSelectionContainer'); // 返回主選單
            // 移除排行榜難度按鈕的 active 類
            document.querySelectorAll('.leaderboard-difficulty-tabs button').forEach(btn => {
                btn.classList.remove('active');
            });
        });

        // 排行榜難度切換按鈕事件
        leaderboardBtnEasy.addEventListener('click', handleLeaderboardDifficultyChange);
        leaderboardBtnMedium.addEventListener('click', handleLeaderboardDifficultyChange);
        leaderboardBtnHard.addEventListener('click', handleLeaderboardDifficultyChange);

        // 處理排行榜難度按鈕切換
        function handleLeaderboardDifficultyChange(event) {
            // 移除所有難度按鈕的 active 類
            document.querySelectorAll('.leaderboard-difficulty-tabs button').forEach(btn => {
                btn.classList.remove('active');
            });
            // 為當前點擊的按鈕添加 active 類
            event.target.classList.add('active');

            const selectedDifficulty = event.target.dataset.difficulty;
            loadLeaderboard(selectedDifficulty);
        }

        // 載入下一題
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            displayQuestion();
        });

        resetGameBtn.addEventListener('click', resetGame);


        // ====== Firebase 整合部分 ======

        // 將分數儲存到 Firebase 排行榜 (已包含難度分類)
        async function saveScoreToLeaderboard(playerName, gameScore, gameTime, gameDifficulty) {
            try {
                // 每個難度一個排行榜集合
                const leaderboardCollectionRef = db.collection('leaderboards').doc(gameDifficulty).collection('scores');
                
                await leaderboardCollectionRef.add({
                    playerName: playerName,
                    score: gameScore,
                    time: gameTime, // 儲存總時間
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // 使用伺服器時間戳記排序
                });
                console.log("Score saved successfully to", gameDifficulty, "leaderboard!");
                // alert("分數已成功記錄到排行榜！"); // 避免多次彈出
            } catch (e) {
                console.error("儲存分數到排行榜時發生錯誤: ", e);
                // alert("記錄分數失敗，請稍後再試。");
            }
        }

        // 從 Firestore 載入並顯示排行榜 (已包含難度分類)
        async function loadLeaderboard(difficultyLevel) {
            leaderboardList.innerHTML = '<li>載入中...</li>';
            try {
                const leaderboardCollectionRef = db.collection('leaderboards').doc(difficultyLevel).collection('scores');
                // 排序：分數高的優先，分數相同則時間短的優先
                const querySnapshot = await leaderboardCollectionRef
                    .orderBy('score', 'desc')
                    .orderBy('time', 'asc')
                    .limit(10) // 只取前10名
                    .get();

                leaderboardList.innerHTML = ''; // 清空舊的列表
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<li>目前沒有分數。</li>';
                    return;
                }

                querySnapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>第 ${index + 1} 名. ${data.playerName}</span>
                        <span>分數: ${data.score} | 時間: ${data.time}s</span>
                    `;
                    leaderboardList.appendChild(listItem);
                });

            } catch (e) {
                console.error("載入排行榜時發生錯誤: ", e);
                leaderboardList.innerHTML = '<li>載入排行榜失敗。</li>';
            }
        }


        // ====== 多人模式 (基礎框架，需要後端配合) ======

        // 這裡提供一個基於 Firestore 的**簡單**多人大廳和房間機制範例
        // 實際的多人遊戲需要更複雜的狀態管理和即時數據同步
        // 並且通常需要一個 Cloud Functions 或其他後端來避免客戶端直接寫入衝突

        
        let roomRef = null; // 當前房間的 Firestore 參考

        createRoomBtn.addEventListener('click', async () => {
            if (!playerNameInput.value.trim()) {
                alert('請輸入你的暱稱！');
                return;
            }
            currentPlayerName = playerNameInput.value.trim().substring(0, 15);

            try {
                // 創建一個新的房間文檔
                const newRoomRef = await db.collection('gameRooms').add({
                    host: currentPlayerName,
                    client: null,
                    status: 'waiting', // 'waiting', 'ready', 'playing', 'finished'
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    questions: [], // 遊戲題目
                    hostScore: 0,
                    clientScore: 0
                });
                currentRoomId = newRoomRef.id;
                roomRef = db.collection('gameRooms').doc(currentRoomId);

                roomNameDisplay.textContent = currentRoomId;
                hostPlayerName.textContent = currentPlayerName;
                clientPlayerName.textContent = '等待玩家...';
                roomStatusMessage.textContent = '等待其他玩家加入房間...';
                startGameBtn.classList.remove('hidden'); // 房主可以開始遊戲

                showScreen('gameRoomContainer');
                listenToRoomChanges(); // 開始監聽房間狀態

            } catch (e) {
                console.error("Error creating room: ", e);
                alert("建立房間失敗，請稍後再試。");
            }
        });

        refreshRoomsBtn.addEventListener('click', refreshRoomList);

        async function refreshRoomList() {
            availableRoomsList.innerHTML = '<li>載入房間中...</li>';
            try {
                const snapshot = await db.collection('gameRooms')
                                        .where('status', 'in', ['waiting', 'ready']) // 顯示等待中和已準備的房間
                                        .get();

                availableRoomsList.innerHTML = '';
                if (snapshot.empty) {
                    availableRoomsList.innerHTML = '<li>目前沒有可用的房間。</li>';
                    return;
                }

                snapshot.forEach(doc => {
                    const room = doc.data();
                    // 只有在房間還沒有客戶端時才顯示「加入」按鈕
                    if (!room.client) {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <span>${room.host} 的房間</span>
                            <button data-room-id="${doc.id}">加入</button>
                        `;
                        listItem.querySelector('button').addEventListener('click', (event) => joinRoom(event.target.dataset.roomId));
                        availableRoomsList.appendChild(listItem);
                    }
                });

            } catch (e) {
                console.error("Error refreshing rooms: ", e);
                availableRoomsList.innerHTML = '<li>載入房間列表失敗。</li>';
            }
        }

        async function joinRoom(roomId) {
            if (!playerNameInput.value.trim()) {
                alert('請輸入你的暱稱！');
                return;
            }
            currentPlayerName = playerNameInput.value.trim().substring(0, 15);

            try {
                roomRef = db.collection('gameRooms').doc(roomId);
                const roomDoc = await roomRef.get();

                if (roomDoc.exists && roomDoc.data().status === 'waiting' && !roomDoc.data().client) {
                    await roomRef.update({
                        client: currentPlayerName,
                        status: 'ready' // 房主和客戶端都準備好
                    });
                    currentRoomId = roomId;
                    roomNameDisplay.textContent = roomId;
                    hostPlayerName.textContent = roomDoc.data().host;
                    clientPlayerName.textContent = currentPlayerName;
                    roomStatusMessage.textContent = '已成功加入房間。等待房主開始遊戲...';
                    startGameBtn.classList.add('hidden'); // 客戶端不能開始遊戲

                    showScreen('gameRoomContainer');
                    listenToRoomChanges(); // 開始監聽房間狀態

                } else {
                    alert('房間不存在、已滿或遊戲已開始。');
                }
            } catch (e) {
                console.error("Error joining room: ", e);
                alert("加入房間失敗，請稍後再試。");
            }
        }

        // 監聽房間狀態變化 (即時更新)
        let roomUnsubscribe = null;
        function listenToRoomChanges() {
            if (roomUnsubscribe) {
                roomUnsubscribe(); // 取消之前的監聽
            }
            if (roomRef) {
                roomUnsubscribe = roomRef.onSnapshot(docSnapshot => {
                    if (docSnapshot.exists) {
                        const roomData = docSnapshot.data();
                        hostPlayerName.textContent = roomData.host;
                        clientPlayerName.textContent = roomData.client || '等待玩家...';

                        if (roomData.status === 'ready') {
                            roomStatusMessage.textContent = '兩位玩家已準備就緒！';
                            if (roomData.host === currentPlayerName) { // 只有房主能看到開始按鈕
                                startGameBtn.classList.remove('hidden');
                            }
                        } else if (roomData.status === 'playing') {
                            roomStatusMessage.textContent = '遊戲進行中...';
                            startGameBtn.classList.add('hidden');
                            // 在這裡可以觸發多人遊戲的開始邏輯
                            // 例如：同步題目索引、顯示題目、等待所有玩家答案等
                            console.log("Multiplayer game started!");
                            // 這裡需要根據多人遊戲的具體機制來設計
                            // 暫時隱藏控制按鈕，遊戲邏輯將由 Room 狀態驅動
                            document.querySelector('#gameRoomContainer .controls').classList.add('hidden');
                            showScreen('gameContainer'); // 進入遊戲畫面
                            
                            if (roomData.host === currentPlayerName && roomData.questions.length === 0) {
                                // 房主在遊戲開始時生成題目 (這裡預設中等難度，可以自行調整)
                                const gameQuestions = [...allQuestions['medium']]; // 多人遊戲統一使用中等難度
                                for (let i = gameQuestions.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [gameQuestions[i], gameQuestions[j]] = [gameQuestions[j], gameQuestions[i]];
                                }
                                roomRef.update({ questions: gameQuestions.slice(0, 10) }); // 多人遊戲取前10題
                            }
                            
                            // 客戶端和房主都從 roomData.questions 讀取題目
                            questions = roomData.questions;
                            totalQuestionsDisplay.textContent = questions.length;
                            
                            // 多人遊戲的題目索引和分數管理會更複雜，通常需要額外的字段
                            // 例如 currentQuestionIndexMultiplayer, hostScore, clientScore
                            // 為了簡化，這裡暫時沿用單人遊戲的 currentQuestionIndex 和 score
                            // 但在真正的多人遊戲中，這些應該是房間狀態的一部分
                            // if (roomData.currentQuestionIndex !== undefined) {
                            //     currentQuestionIndex = roomData.currentQuestionIndex;
                            // }
                            // if (roomData.hostScore !== undefined && roomData.clientScore !== undefined) {
                            //     scoreDisplay.textContent = currentPlayerName === roomData.host ? roomData.hostScore : roomData.clientScore;
                            // }

                            displayQuestion(); // 顯示當前題目 (需要題目和索引已同步)

                        } else if (roomData.status === 'finished') {
                            roomStatusMessage.textContent = `遊戲結束！房主 (${roomData.host}) 得分: ${roomData.hostScore}, 玩家 (${roomData.client}) 得分: ${roomData.clientScore}`;
                            startGameBtn.classList.add('hidden');
                            document.querySelector('#gameRoomContainer .controls').classList.remove('hidden'); // 遊戲結束後顯示控制按鈕
                            // 顯示最終結果，並提供返回大廳的選項
                            showScreen('gameRoomContainer'); // 遊戲結束回到房間介面
                        } else if (roomData.status === 'waiting' && roomData.client === null) {
                            roomStatusMessage.textContent = '等待其他玩家加入房間...';
                        }
                    } else {
                        // 房間不存在 (可能被刪除了)
                        alert('房間已解散或不存在。');
                        leaveRoom(); // 強制離開房間
                    }
                }, error => {
                    console.error("Error listening to room changes: ", error);
                    alert("監聽房間狀態失敗，請重新整理。");
                    leaveRoom(); // 發生錯誤時也離開
                });
            }
        }

        startGameBtn.addEventListener('click', async () => {
            if (currentRoomId && roomRef) {
                // 房主點擊開始遊戲
                // 在開始遊戲前，先為多人遊戲生成題目並儲存到房間數據中
                const gameQuestions = [...allQuestions['medium']]; // 多人遊戲統一使用中等難度
                for (let i = gameQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [gameQuestions[i], gameQuestions[j]] = [gameQuestions[j], gameQuestions[i]];
                }
                const selectedQuestions = gameQuestions.slice(0, 10); // 多人遊戲取前10題

                await roomRef.update({
                    status: 'playing',
                    hostScore: 0,
                    clientScore: 0,
                    currentQuestionIndex: 0, // 重置多人遊戲進度
                    questions: selectedQuestions // 將題目儲存到房間數據中
                });
                // 遊戲畫面會監聽到 status 變為 'playing' 並開始遊戲
            }
        });

        leaveRoomBtn.addEventListener('click', leaveRoom);

        async function leaveRoom() {
            if (currentRoomId && roomRef) {
                try {
                    const roomDoc = await roomRef.get();
                    if (roomDoc.exists) {
                        const roomData = roomDoc.data();
                        if (roomData.host === currentPlayerName) {
                            // 如果是房主，直接刪除房間
                            await roomRef.delete();
                            console.log('房間已解散。');
                        } else if (roomData.client === currentPlayerName) {
                            // 如果是客戶端，移除自己
                            await roomRef.update({ client: null, status: 'waiting' });
                            console.log('已離開房間。');
                        }
                    }
                } catch (e) {
                    console.error("Error leaving/deleting room: ", e);
                } finally {
                    if (roomUnsubscribe) {
                        roomUnsubscribe(); // 取消監聽
                        roomUnsubscribe = null;
                    }
                    currentRoomId = null;
                    roomRef = null;
                    showScreen('multiplayerLobbyContainer'); // 返回大廳
                    refreshRoomList();
                    resetGame(); // 清理遊戲狀態
                }
            } else {
                showScreen('multiplayerLobbyContainer'); // 沒有房間直接回大廳
                refreshRoomList();
            }
        }

        // 初始載入時顯示主選單
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('levelSelectionContainer');
            // 確保難度選擇器在開始時是可見的
            difficultySelect.classList.remove('hidden'); 
        });

    </script>
</body>
</html>
